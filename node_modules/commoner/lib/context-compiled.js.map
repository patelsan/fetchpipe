{"version":3,"sources":["context.js"],"names":[],"mappings":"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","file":"context-compiled.js","sourcesContent":["var assert = require(\"assert\");\nvar path = require(\"path\");\nvar Q = require(\"q\");\nvar util = require(\"./util\");\nvar spawn = require(\"child_process\").spawn;\nvar ReadFileCache = require(\"./cache\").ReadFileCache;\nvar grepP = require(\"./grep\");\nvar glob = require(\"glob\");\nvar env = process.env;\n\nfunction BuildContext(options, readFileCache) {\n    var self = this;\n    assert.ok(self instanceof BuildContext);\n    assert.ok(readFileCache instanceof ReadFileCache);\n\n    if (options) {\n        assert.strictEqual(typeof options, \"object\");\n    } else {\n        options = {};\n    }\n\n    Object.freeze(options);\n\n    Object.defineProperties(self, {\n        readFileCache: { value: readFileCache },\n        config: { value: options.config },\n        options: { value: options },\n        optionsHash: { value: util.deepHash(options) }\n    });\n}\n\nvar BCp = BuildContext.prototype;\n\nBCp.makePromise = function(callback, context) {\n    return util.makePromise(callback, context);\n};\n\nBCp.spawnP = function(command, args, kwargs) {\n    args = args || [];\n    kwargs = kwargs || {};\n\n    var deferred = Q.defer();\n\n    var outs = [];\n    var errs = [];\n\n    var options = {\n        stdio: \"pipe\",\n        env: env\n    };\n\n    if (kwargs.cwd) {\n        options.cwd = kwargs.cwd;\n    }\n\n    var child = spawn(command, args, options);\n\n    child.stdout.on(\"data\", function(data) {\n        outs.push(data);\n    });\n\n    child.stderr.on(\"data\", function(data) {\n        errs.push(data);\n    });\n\n    child.on(\"close\", function(code) {\n        if (errs.length > 0 || code !== 0) {\n            var err = {\n                code: code,\n                text: errs.join(\"\")\n            };\n        }\n\n        deferred.resolve([err, outs.join(\"\")]);\n    });\n\n    var stdin = kwargs && kwargs.stdin;\n    if (stdin) {\n        child.stdin.end(stdin);\n    }\n\n    return deferred.promise;\n};\n\nBCp.setIgnoreDependencies = function(value) {\n    Object.defineProperty(this, \"ignoreDependencies\", {\n        value: !!value\n    });\n};\n\n// This default can be overridden by individual BuildContext instances.\nBCp.setIgnoreDependencies(false);\n\nBCp.setRelativize = function(value) {\n    Object.defineProperty(this, \"relativize\", {\n        value: !!value\n    });\n};\n\n// This default can be overridden by individual BuildContext instances.\nBCp.setRelativize(false);\n\nBCp.setUseProvidesModule = function(value) {\n    Object.defineProperty(this, \"useProvidesModule\", {\n        value: !!value\n    });\n};\n\n// This default can be overridden by individual BuildContext instances.\nBCp.setUseProvidesModule(false);\n\nBCp.setCacheDirectory = function(dir) {\n    if (!dir) {\n        // Disable the cache directory.\n    } else {\n        assert.strictEqual(typeof dir, \"string\");\n    }\n\n    Object.defineProperty(this, \"cacheDir\", {\n        value: dir || null\n    });\n};\n\n// This default can be overridden by individual BuildContext instances.\nBCp.setCacheDirectory(null);\n\nfunction PreferredFileExtension(ext) {\n    assert.strictEqual(typeof ext, \"string\");\n    assert.ok(this instanceof PreferredFileExtension);\n    Object.defineProperty(this, \"extension\", {\n        value: ext.toLowerCase()\n    });\n}\n\nvar PFEp = PreferredFileExtension.prototype;\n\nPFEp.check = function(file) {\n    return file.split(\".\").pop().toLowerCase() === this.extension;\n};\n\nPFEp.trim = function(file) {\n    if (this.check(file)) {\n        var len = file.length;\n        var extLen = 1 + this.extension.length;\n        file = file.slice(0, len - extLen);\n    }\n    return file;\n};\n\nPFEp.glob = function() {\n    return \"**/*.\" + this.extension;\n};\n\nexports.PreferredFileExtension = PreferredFileExtension;\n\nBCp.setPreferredFileExtension = function(pfe) {\n    assert.ok(pfe instanceof PreferredFileExtension);\n    Object.defineProperty(this, \"preferredFileExtension\", { value: pfe });\n};\n\nBCp.setPreferredFileExtension(new PreferredFileExtension(\"js\"));\n\nBCp.expandIdsOrGlobsP = function(idsOrGlobs) {\n    var context = this;\n\n    return Q.all(\n        idsOrGlobs.map(this.expandSingleIdOrGlobP, this)\n    ).then(function(listOfListsOfIDs) {\n        var result = [];\n        var seen = {};\n\n        util.flatten(listOfListsOfIDs).forEach(function(id) {\n            if (!seen.hasOwnProperty(id)) {\n                seen[id] = true;\n                if (util.isValidModuleId(id))\n                    result.push(id);\n            }\n        });\n\n        return result;\n    });\n};\n\nBCp.expandSingleIdOrGlobP = function(idOrGlob) {\n    var context = this;\n\n    return util.makePromise(function(callback) {\n        // If idOrGlob already looks like an acceptable identifier, don't\n        // try to expand it.\n        if (util.isValidModuleId(idOrGlob)) {\n            callback(null, [idOrGlob]);\n            return;\n        }\n\n        glob(idOrGlob, {\n            cwd: context.readFileCache.sourceDir\n        }, function(err, files) {\n            if (err) {\n                callback(err);\n            } else {\n                callback(null, files.filter(function(file) {\n                    return !context.isHiddenFile(file);\n                }).map(function(file) {\n                    return context.preferredFileExtension.trim(file);\n                }));\n            }\n        });\n    });\n};\n\nBCp.readModuleP = function(id) {\n    return this.readFileCache.readFileP(\n        id + \".\" + this.preferredFileExtension.extension\n    );\n};\n\nBCp.readFileP = function(file) {\n    return this.readFileCache.readFileP(file);\n};\n\n// Text editors such as VIM and Emacs often create temporary swap files\n// that should be ignored.\nvar hiddenExp = /^\\.|~$/;\nBCp.isHiddenFile = function(file) {\n    return hiddenExp.test(path.basename(file));\n};\n\nBCp.getProvidedP = util.cachedMethod(function() {\n    var context = this;\n    var pattern = \"@providesModule\\\\s+\\\\S+\";\n\n    return grepP(\n        pattern,\n        context.readFileCache.sourceDir\n    ).then(function(pathToMatch) {\n        var idToPath = {};\n\n        Object.keys(pathToMatch).sort().forEach(function(path) {\n            if (context.isHiddenFile(path))\n                return;\n\n            var id = pathToMatch[path].split(/\\s+/).pop();\n\n            // If we're about to overwrite an existing module identifier,\n            // make sure the corresponding path ends with the preferred\n            // file extension. This allows @providesModule directives in\n            // .coffee files, for example, but prevents .js~ temporary\n            // files from taking precedence over actual .js files.\n            if (!idToPath.hasOwnProperty(id) ||\n                context.preferredFileExtension.check(path))\n                idToPath[id] = path;\n        });\n\n        return idToPath;\n    });\n});\n\nvar providesExp = /@providesModule[ ]+(\\S+)/;\n\nBCp.getProvidedId = function(source) {\n    var match = providesExp.exec(source);\n    return match && match[1];\n};\n\nexports.BuildContext = BuildContext;\n"]}