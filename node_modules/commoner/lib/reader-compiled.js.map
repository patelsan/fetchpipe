{"version":3,"sources":["reader.js"],"names":[],"mappings":"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","file":"reader-compiled.js","sourcesContent":["var assert = require(\"assert\");\nvar path = require(\"path\");\nvar fs = require(\"fs\");\nvar Q = require(\"q\");\nvar iconv = require(\"iconv-lite\");\nvar createHash = require(\"crypto\").createHash;\nvar getRequiredIDs = require(\"install\").getRequiredIDs;\nvar util = require(\"./util\");\nvar BuildContext = require(\"./context\").BuildContext;\nvar slice = Array.prototype.slice;\n\nfunction ModuleReader(context, resolvers, processors) {\n    var self = this;\n    assert.ok(self instanceof ModuleReader);\n    assert.ok(context instanceof BuildContext);\n    assert.ok(resolvers instanceof Array);\n    assert.ok(processors instanceof Array);\n\n    var hash = createHash(\"sha1\").update(context.optionsHash + \"\\0\");\n\n    function hashCallbacks(salt) {\n        hash.update(salt + \"\\0\");\n\n        var cbs = util.flatten(slice.call(arguments, 1));\n\n        cbs.forEach(function(cb) {\n            assert.strictEqual(typeof cb, \"function\");\n            hash.update(cb + \"\\0\");\n        });\n\n        return cbs;\n    }\n\n    resolvers = hashCallbacks(\"resolvers\", resolvers, warnMissingModule);\n\n    var procArgs = [processors];\n    if (context.relativize && !context.ignoreDependencies)\n        procArgs.push(require(\"./relative\").getProcessor(self));\n    processors = hashCallbacks(\"processors\", procArgs);\n\n    Object.defineProperties(self, {\n        context: { value: context },\n        idToHash: { value: {} },\n        resolvers: { value: resolvers },\n        processors: { value: processors },\n        salt: { value: hash.digest(\"hex\") }\n    });\n}\n\nModuleReader.prototype = {\n    getSourceP: util.cachedMethod(function(id) {\n        var context = this.context;\n        var copy = this.resolvers.slice(0).reverse();\n        assert.ok(copy.length > 0, \"no source resolvers registered\");\n\n        function tryNextResolverP() {\n            var resolve = copy.pop();\n\n            try {\n                var promise = Q(resolve && resolve.call(context, id));\n            } catch (e) {\n                promise = Q.reject(e);\n            }\n\n            return resolve ? promise.then(function(result) {\n                if (typeof result === \"string\")\n                    return result;\n                return tryNextResolverP();\n            }, tryNextResolverP) : promise;\n        }\n\n        return tryNextResolverP();\n    }),\n\n    getCanonicalIdP: util.cachedMethod(function(id) {\n        var reader = this;\n        if (reader.context.useProvidesModule) {\n            return reader.getSourceP(id).then(function(source) {\n                return reader.context.getProvidedId(source) || id;\n            });\n        } else {\n          return Q(id);\n        }\n    }),\n\n    readModuleP: util.cachedMethod(function(id) {\n        var reader = this;\n\n        return reader.getSourceP(id).then(function(source) {\n            if (reader.context.useProvidesModule) {\n                // If the source contains a @providesModule declaration, treat\n                // that declaration as canonical. Note that the Module object\n                // returned by readModuleP might have an .id property whose\n                // value differs from the original id parameter.\n                id = reader.context.getProvidedId(source) || id;\n            }\n\n            assert.strictEqual(typeof source, \"string\");\n\n            var hash = createHash(\"sha1\")\n                .update(\"module\\0\")\n                .update(id + \"\\0\")\n                .update(reader.salt + \"\\0\")\n                .update(source.length + \"\\0\" + source)\n                .digest(\"hex\");\n\n            if (reader.idToHash.hasOwnProperty(id)) {\n                // Ensure that the same module identifier is not\n                // provided by distinct modules.\n                assert.strictEqual(\n                    reader.idToHash[id], hash,\n                    \"more than one module named \" +\n                        JSON.stringify(id));\n            } else {\n                reader.idToHash[id] = hash;\n            }\n\n            return reader.buildModuleP(id, hash, source);\n        });\n    }),\n\n    buildModuleP: util.cachedMethod(function(id, hash, source) {\n        var reader = this;\n        return reader.processOutputP(\n            id, hash, source\n        ).then(function(output) {\n            return new Module(reader, id, hash, output);\n        });\n    }, function(id, hash, source) {\n        return hash;\n    }),\n\n    processOutputP: function(id, hash, source) {\n        var reader = this;\n        var cacheDir = reader.context.cacheDir;\n        var manifestDir = cacheDir && path.join(cacheDir, \"manifest\");\n        var charset = reader.context.options.outputCharset;\n\n        function buildP() {\n            var promise = Q(source);\n\n            reader.processors.forEach(function(build) {\n                promise = promise.then(function(input) {\n                    return util.waitForValuesP(\n                        build.call(reader.context, id, input)\n                    );\n                });\n            });\n\n            return promise.then(function(output) {\n                if (typeof output === \"string\") {\n                    output = { \".js\": output };\n                } else {\n                    assert.strictEqual(typeof output, \"object\");\n                }\n\n                return util.waitForValuesP(output);\n\n            }).then(function(output) {\n                util.log.err(\n                    \"built Module(\" + JSON.stringify(id) + \")\",\n                    \"cyan\"\n                );\n\n                return output;\n\n            }).catch(function(err) {\n                // Provide additional context for uncaught build errors.\n                util.log.err(\"Error while reading module \" + id + \":\");\n                throw err;\n            });\n        }\n\n        if (manifestDir) {\n            return util.mkdirP(manifestDir).then(function(manifestDir) {\n                var manifestFile = path.join(manifestDir, hash + \".json\");\n\n                return util.readJsonFileP(manifestFile).then(function(manifest) {\n                    Object.keys(manifest).forEach(function(key) {\n                        var cacheFile = path.join(cacheDir, manifest[key]);\n                        manifest[key] = util.readFileP(cacheFile);\n                    });\n\n                    return util.waitForValuesP(manifest, true);\n\n                }).catch(function(err) {\n                    return buildP().then(function(output) {\n                        var manifest = {};\n\n                        Object.keys(output).forEach(function(key) {\n                            var cacheFile = manifest[key] = hash + key;\n                            var fullPath = path.join(cacheDir, cacheFile);\n\n                            if (charset) {\n                                fs.writeFileSync(fullPath, iconv.encode(output[key], charset))\n                            } else {\n                                fs.writeFileSync(fullPath, output[key], \"utf8\");\n                            }\n                        });\n\n                        fs.writeFileSync(\n                            manifestFile,\n                            JSON.stringify(manifest),\n                            \"utf8\"\n                        );\n\n                        return output;\n                    });\n                });\n            });\n        }\n\n        return buildP();\n    },\n\n    readMultiP: function(ids) {\n        var reader = this;\n\n        return Q(ids).all().then(function(ids) {\n            if (ids.length === 0)\n                return ids; // Shortcut.\n\n            var modulePs = ids.map(reader.readModuleP, reader);\n            return Q(modulePs).all().then(function(modules) {\n                var seen = {};\n                var result = [];\n\n                modules.forEach(function(module) {\n                    if (!seen.hasOwnProperty(module.id)) {\n                        seen[module.id] = true;\n                        result.push(module);\n                    }\n                });\n\n                return result;\n            });\n        });\n    }\n};\n\nexports.ModuleReader = ModuleReader;\n\nfunction warnMissingModule(id) {\n    // A missing module may be a false positive and therefore does not warrant\n    // a fatal error, but a warning is certainly in order.\n    util.log.err(\n        \"unable to resolve module \" + JSON.stringify(id) + \"; false positive?\",\n        \"yellow\");\n\n    // Missing modules are installed as if they existed, but it's a run-time\n    // error if one is ever actually required.\n    var message = \"nonexistent module required: \" + id;\n    return \"throw new Error(\" + JSON.stringify(message) + \");\";\n}\n\nfunction Module(reader, id, hash, output) {\n    assert.ok(this instanceof Module);\n    assert.ok(reader instanceof ModuleReader);\n    assert.strictEqual(typeof output, \"object\");\n\n    var source = output[\".js\"];\n    assert.strictEqual(typeof source, \"string\");\n\n    Object.defineProperties(this, {\n        reader: { value: reader },\n        id: { value: id },\n        hash: { value: hash }, // TODO Remove?\n        deps: { value: getRequiredIDs(id, source) },\n        source: { value: source },\n        output: { value: output }\n    });\n}\n\nModule.prototype = {\n    getRequiredP: function() {\n        return this.reader.readMultiP(this.deps);\n    },\n\n    writeVersionP: function(outputDir) {\n        var id = this.id;\n        var hash = this.hash;\n        var output = this.output;\n        var cacheDir = this.reader.context.cacheDir;\n        var charset = this.reader.context.options.outputCharset;\n\n        return Q.all(Object.keys(output).map(function(key) {\n            var outputFile = path.join(outputDir, id + key);\n\n            function writeCopy() {\n                if (charset) {\n                    fs.writeFileSync(outputFile, iconv.encode(output[key], charset));\n                } else {\n                    fs.writeFileSync(outputFile, output[key], \"utf8\");\n                }\n                return outputFile;\n            }\n\n            if (cacheDir) {\n                var cacheFile = path.join(cacheDir, hash + key);\n                return util.linkP(cacheFile, outputFile)\n                    // If the hard linking fails, the cache directory\n                    // might be on a different device, so fall back to\n                    // writing a copy of the file (slightly slower).\n                    .catch(writeCopy);\n            }\n\n            return util.mkdirP(path.dirname(outputFile)).then(writeCopy);\n        }));\n    },\n\n    toString: function() {\n        return \"Module(\" + JSON.stringify(this.id) + \")\";\n    },\n\n    resolveId: function(id) {\n        return util.absolutize(this.id, id);\n    }\n};\n"]}