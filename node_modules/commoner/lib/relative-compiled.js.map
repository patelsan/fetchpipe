{"version":3,"sources":["relative.js"],"names":[],"mappings":"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","file":"relative-compiled.js","sourcesContent":["var assert = require(\"assert\");\nvar Q = require(\"q\");\nvar path = require(\"path\");\nvar util = require(\"./util\");\nvar recast = require(\"recast\");\nvar n = recast.types.namedTypes;\n\nfunction Relativizer(reader) {\n    assert.ok(this instanceof Relativizer);\n    assert.ok(reader === null ||\n              reader instanceof require(\"./reader\").ModuleReader);\n\n    Object.defineProperties(this, {\n        reader: { value: reader }\n    });\n}\n\nvar Rp = Relativizer.prototype;\n\nexports.getProcessor = function(reader) {\n    var relativizer = new Relativizer(reader);\n    return function(id, input) {\n        return relativizer.processSourceP(id, input);\n    };\n};\n\nRp.processSourceP = function(id, input) {\n    var relativizer = this;\n    var output = typeof input === \"string\" ? {\n        \".js\": input\n    } : input;\n\n    return Q(output[\".js\"]).then(function(source) {\n        var promises = [];\n        var ast = recast.parse(source);\n\n        function fixRequireP(literal) {\n            promises.push(relativizer.relativizeP(\n                id, literal.value\n            ).then(function(newValue) {\n                return literal.value = newValue;\n            }));\n        }\n\n        recast.visit(ast, {\n            visitCallExpression: function(path) {\n                var args = path.value.arguments;\n                var callee = path.value.callee;\n\n                if (n.Identifier.check(callee) &&\n                    callee.name === \"require\" &&\n                    args.length === 1) {\n                    var arg = args[0];\n                    if (n.Literal.check(arg) &&\n                        typeof arg.value === \"string\") {\n                        fixRequireP(arg);\n                    }\n                }\n\n                this.traverse(path);\n            }\n        });\n\n        return Q.all(promises).then(function() {\n            output[\".js\"] = recast.print(ast).code;\n            return output;\n        });\n    });\n};\n\nRp.absolutizeP = function(moduleId, requiredId) {\n    requiredId = util.absolutize(moduleId, requiredId);\n\n    if (this.reader)\n        return this.reader.getCanonicalIdP(requiredId);\n\n    return Q(requiredId);\n};\n\nRp.relativizeP = function(moduleId, requiredId) {\n    return this.absolutizeP(\n        moduleId,\n        requiredId\n    ).then(function(absoluteId) {\n        return util.relativize(moduleId, absoluteId);\n    });\n};\n"]}