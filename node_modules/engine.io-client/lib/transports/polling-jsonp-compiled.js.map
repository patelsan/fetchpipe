{"version":3,"sources":["polling-jsonp.js"],"names":[],"mappings":"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","file":"polling-jsonp-compiled.js","sourcesContent":["\n/**\n * Module requirements.\n */\n\nvar Polling = require('./polling');\nvar inherit = require('component-inherit');\n\n/**\n * Module exports.\n */\n\nmodule.exports = JSONPPolling;\n\n/**\n * Cached regular expressions.\n */\n\nvar rNewline = /\\n/g;\nvar rEscapedNewline = /\\\\n/g;\n\n/**\n * Global JSONP callbacks.\n */\n\nvar callbacks;\n\n/**\n * Callbacks count.\n */\n\nvar index = 0;\n\n/**\n * Noop.\n */\n\nfunction empty () { }\n\n/**\n * JSONP Polling constructor.\n *\n * @param {Object} opts.\n * @api public\n */\n\nfunction JSONPPolling (opts) {\n  Polling.call(this, opts);\n\n  this.query = this.query || {};\n\n  // define global callbacks array if not present\n  // we do this here (lazily) to avoid unneeded global pollution\n  if (!callbacks) {\n    // we need to consider multiple engines in the same page\n    if (!global.___eio) global.___eio = [];\n    callbacks = global.___eio;\n  }\n\n  // callback identifier\n  this.index = callbacks.length;\n\n  // add callback to jsonp global\n  var self = this;\n  callbacks.push(function (msg) {\n    self.onData(msg);\n  });\n\n  // append to query string\n  this.query.j = this.index;\n\n  // prevent spurious errors from being emitted when the window is unloaded\n  if (global.document && global.addEventListener) {\n    global.addEventListener('beforeunload', function () {\n      if (self.script) self.script.onerror = empty;\n    }, false);\n  }\n}\n\n/**\n * Inherits from Polling.\n */\n\ninherit(JSONPPolling, Polling);\n\n/*\n * JSONP only supports binary as base64 encoded strings\n */\n\nJSONPPolling.prototype.supportsBinary = false;\n\n/**\n * Closes the socket.\n *\n * @api private\n */\n\nJSONPPolling.prototype.doClose = function () {\n  if (this.script) {\n    this.script.parentNode.removeChild(this.script);\n    this.script = null;\n  }\n\n  if (this.form) {\n    this.form.parentNode.removeChild(this.form);\n    this.form = null;\n    this.iframe = null;\n  }\n\n  Polling.prototype.doClose.call(this);\n};\n\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\nJSONPPolling.prototype.doPoll = function () {\n  var self = this;\n  var script = document.createElement('script');\n\n  if (this.script) {\n    this.script.parentNode.removeChild(this.script);\n    this.script = null;\n  }\n\n  script.async = true;\n  script.src = this.uri();\n  script.onerror = function(e){\n    self.onError('jsonp poll error',e);\n  };\n\n  var insertAt = document.getElementsByTagName('script')[0];\n  insertAt.parentNode.insertBefore(script, insertAt);\n  this.script = script;\n\n  var isUAgecko = 'undefined' != typeof navigator && /gecko/i.test(navigator.userAgent);\n  \n  if (isUAgecko) {\n    setTimeout(function () {\n      var iframe = document.createElement('iframe');\n      document.body.appendChild(iframe);\n      document.body.removeChild(iframe);\n    }, 100);\n  }\n};\n\n/**\n * Writes with a hidden iframe.\n *\n * @param {String} data to send\n * @param {Function} called upon flush.\n * @api private\n */\n\nJSONPPolling.prototype.doWrite = function (data, fn) {\n  var self = this;\n\n  if (!this.form) {\n    var form = document.createElement('form');\n    var area = document.createElement('textarea');\n    var id = this.iframeId = 'eio_iframe_' + this.index;\n    var iframe;\n\n    form.className = 'socketio';\n    form.style.position = 'absolute';\n    form.style.top = '-1000px';\n    form.style.left = '-1000px';\n    form.target = id;\n    form.method = 'POST';\n    form.setAttribute('accept-charset', 'utf-8');\n    area.name = 'd';\n    form.appendChild(area);\n    document.body.appendChild(form);\n\n    this.form = form;\n    this.area = area;\n  }\n\n  this.form.action = this.uri();\n\n  function complete () {\n    initIframe();\n    fn();\n  }\n\n  function initIframe () {\n    if (self.iframe) {\n      try {\n        self.form.removeChild(self.iframe);\n      } catch (e) {\n        self.onError('jsonp polling iframe removal error', e);\n      }\n    }\n\n    try {\n      // ie6 dynamic iframes with target=\"\" support (thanks Chris Lambacher)\n      var html = '<iframe src=\"javascript:0\" name=\"'+ self.iframeId +'\">';\n      iframe = document.createElement(html);\n    } catch (e) {\n      iframe = document.createElement('iframe');\n      iframe.name = self.iframeId;\n      iframe.src = 'javascript:0';\n    }\n\n    iframe.id = self.iframeId;\n\n    self.form.appendChild(iframe);\n    self.iframe = iframe;\n  }\n\n  initIframe();\n\n  // escape \\n to prevent it from being converted into \\r\\n by some UAs\n  // double escaping is required for escaped new lines because unescaping of new lines can be done safely on server-side\n  data = data.replace(rEscapedNewline, '\\\\\\n');\n  this.area.value = data.replace(rNewline, '\\\\n');\n\n  try {\n    this.form.submit();\n  } catch(e) {}\n\n  if (this.iframe.attachEvent) {\n    this.iframe.onreadystatechange = function(){\n      if (self.iframe.readyState == 'complete') {\n        complete();\n      }\n    };\n  } else {\n    this.iframe.onload = complete;\n  }\n};\n"]}