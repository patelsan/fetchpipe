{"version":3,"sources":["polling-xhr.js"],"names":[],"mappings":"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","file":"polling-xhr-compiled.js","sourcesContent":["/**\n * Module requirements.\n */\n\nvar XMLHttpRequest = require('xmlhttprequest');\nvar Polling = require('./polling');\nvar Emitter = require('component-emitter');\nvar inherit = require('component-inherit');\nvar debug = require('debug')('engine.io-client:polling-xhr');\n\n/**\n * Module exports.\n */\n\nmodule.exports = XHR;\nmodule.exports.Request = Request;\n\n/**\n * Empty function\n */\n\nfunction empty(){}\n\n/**\n * XHR Polling constructor.\n *\n * @param {Object} opts\n * @api public\n */\n\nfunction XHR(opts){\n  Polling.call(this, opts);\n\n  if (global.location) {\n    var isSSL = 'https:' == location.protocol;\n    var port = location.port;\n\n    // some user agents have empty `location.port`\n    if (!port) {\n      port = isSSL ? 443 : 80;\n    }\n\n    this.xd = opts.hostname != global.location.hostname ||\n      port != opts.port;\n    this.xs = opts.secure != isSSL;\n  }\n}\n\n/**\n * Inherits from Polling.\n */\n\ninherit(XHR, Polling);\n\n/**\n * XHR supports binary\n */\n\nXHR.prototype.supportsBinary = true;\n\n/**\n * Creates a request.\n *\n * @param {String} method\n * @api private\n */\n\nXHR.prototype.request = function(opts){\n  opts = opts || {};\n  opts.uri = this.uri();\n  opts.xd = this.xd;\n  opts.xs = this.xs;\n  opts.agent = this.agent || false;\n  opts.supportsBinary = this.supportsBinary;\n  opts.enablesXDR = this.enablesXDR;\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n\n  return new Request(opts);\n};\n\n/**\n * Sends data.\n *\n * @param {String} data to send.\n * @param {Function} called upon flush.\n * @api private\n */\n\nXHR.prototype.doWrite = function(data, fn){\n  var isBinary = typeof data !== 'string' && data !== undefined;\n  var req = this.request({ method: 'POST', data: data, isBinary: isBinary });\n  var self = this;\n  req.on('success', fn);\n  req.on('error', function(err){\n    self.onError('xhr post error', err);\n  });\n  this.sendXhr = req;\n};\n\n/**\n * Starts a poll cycle.\n *\n * @api private\n */\n\nXHR.prototype.doPoll = function(){\n  debug('xhr poll');\n  var req = this.request();\n  var self = this;\n  req.on('data', function(data){\n    self.onData(data);\n  });\n  req.on('error', function(err){\n    self.onError('xhr poll error', err);\n  });\n  this.pollXhr = req;\n};\n\n/**\n * Request constructor\n *\n * @param {Object} options\n * @api public\n */\n\nfunction Request(opts){\n  this.method = opts.method || 'GET';\n  this.uri = opts.uri;\n  this.xd = !!opts.xd;\n  this.xs = !!opts.xs;\n  this.async = false !== opts.async;\n  this.data = undefined != opts.data ? opts.data : null;\n  this.agent = opts.agent;\n  this.isBinary = opts.isBinary;\n  this.supportsBinary = opts.supportsBinary;\n  this.enablesXDR = opts.enablesXDR;\n\n  // SSL options for Node.js client\n  this.pfx = opts.pfx;\n  this.key = opts.key;\n  this.passphrase = opts.passphrase;\n  this.cert = opts.cert;\n  this.ca = opts.ca;\n  this.ciphers = opts.ciphers;\n  this.rejectUnauthorized = opts.rejectUnauthorized;\n\n  this.create();\n}\n\n/**\n * Mix in `Emitter`.\n */\n\nEmitter(Request.prototype);\n\n/**\n * Creates the XHR object and sends the request.\n *\n * @api private\n */\n\nRequest.prototype.create = function(){\n  var opts = { agent: this.agent, xdomain: this.xd, xscheme: this.xs, enablesXDR: this.enablesXDR };\n\n  // SSL options for Node.js client\n  opts.pfx = this.pfx;\n  opts.key = this.key;\n  opts.passphrase = this.passphrase;\n  opts.cert = this.cert;\n  opts.ca = this.ca;\n  opts.ciphers = this.ciphers;\n  opts.rejectUnauthorized = this.rejectUnauthorized;\n\n  var xhr = this.xhr = new XMLHttpRequest(opts);\n  var self = this;\n\n  try {\n    debug('xhr open %s: %s', this.method, this.uri);\n    xhr.open(this.method, this.uri, this.async);\n    if (this.supportsBinary) {\n      // This has to be done after open because Firefox is stupid\n      // http://stackoverflow.com/questions/13216903/get-binary-data-with-xmlhttprequest-in-a-firefox-extension\n      xhr.responseType = 'arraybuffer';\n    }\n\n    if ('POST' == this.method) {\n      try {\n        if (this.isBinary) {\n          xhr.setRequestHeader('Content-type', 'application/octet-stream');\n        } else {\n          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');\n        }\n      } catch (e) {}\n    }\n\n    // ie6 check\n    if ('withCredentials' in xhr) {\n      xhr.withCredentials = true;\n    }\n\n    if (this.hasXDR()) {\n      xhr.onload = function(){\n        self.onLoad();\n      };\n      xhr.onerror = function(){\n        self.onError(xhr.responseText);\n      };\n    } else {\n      xhr.onreadystatechange = function(){\n        if (4 != xhr.readyState) return;\n        if (200 == xhr.status || 1223 == xhr.status) {\n          self.onLoad();\n        } else {\n          // make sure the `error` event handler that's user-set\n          // does not throw in the same tick and gets caught here\n          setTimeout(function(){\n            self.onError(xhr.status);\n          }, 0);\n        }\n      };\n    }\n\n    debug('xhr data %s', this.data);\n    xhr.send(this.data);\n  } catch (e) {\n    // Need to defer since .create() is called directly fhrom the constructor\n    // and thus the 'error' event can only be only bound *after* this exception\n    // occurs.  Therefore, also, we cannot throw here at all.\n    setTimeout(function() {\n      self.onError(e);\n    }, 0);\n    return;\n  }\n\n  if (global.document) {\n    this.index = Request.requestsCount++;\n    Request.requests[this.index] = this;\n  }\n};\n\n/**\n * Called upon successful response.\n *\n * @api private\n */\n\nRequest.prototype.onSuccess = function(){\n  this.emit('success');\n  this.cleanup();\n};\n\n/**\n * Called if we have data.\n *\n * @api private\n */\n\nRequest.prototype.onData = function(data){\n  this.emit('data', data);\n  this.onSuccess();\n};\n\n/**\n * Called upon error.\n *\n * @api private\n */\n\nRequest.prototype.onError = function(err){\n  this.emit('error', err);\n  this.cleanup(true);\n};\n\n/**\n * Cleans up house.\n *\n * @api private\n */\n\nRequest.prototype.cleanup = function(fromError){\n  if ('undefined' == typeof this.xhr || null === this.xhr) {\n    return;\n  }\n  // xmlhttprequest\n  if (this.hasXDR()) {\n    this.xhr.onload = this.xhr.onerror = empty;\n  } else {\n    this.xhr.onreadystatechange = empty;\n  }\n\n  if (fromError) {\n    try {\n      this.xhr.abort();\n    } catch(e) {}\n  }\n\n  if (global.document) {\n    delete Request.requests[this.index];\n  }\n\n  this.xhr = null;\n};\n\n/**\n * Called upon load.\n *\n * @api private\n */\n\nRequest.prototype.onLoad = function(){\n  var data;\n  try {\n    var contentType;\n    try {\n      contentType = this.xhr.getResponseHeader('Content-Type').split(';')[0];\n    } catch (e) {}\n    if (contentType === 'application/octet-stream') {\n      data = this.xhr.response;\n    } else {\n      if (!this.supportsBinary) {\n        data = this.xhr.responseText;\n      } else {\n        data = 'ok';\n      }\n    }\n  } catch (e) {\n    this.onError(e);\n  }\n  if (null != data) {\n    this.onData(data);\n  }\n};\n\n/**\n * Check if it has XDomainRequest.\n *\n * @api private\n */\n\nRequest.prototype.hasXDR = function(){\n  return 'undefined' !== typeof global.XDomainRequest && !this.xs && this.enablesXDR;\n};\n\n/**\n * Aborts the request.\n *\n * @api public\n */\n\nRequest.prototype.abort = function(){\n  this.cleanup();\n};\n\n/**\n * Aborts pending requests when unloading the window. This is needed to prevent\n * memory leaks (e.g. when using IE) and to ensure that no spurious error is\n * emitted.\n */\n\nif (global.document) {\n  Request.requestsCount = 0;\n  Request.requests = {};\n  if (global.attachEvent) {\n    global.attachEvent('onunload', unloadHandler);\n  } else if (global.addEventListener) {\n    global.addEventListener('beforeunload', unloadHandler, false);\n  }\n}\n\nfunction unloadHandler() {\n  for (var i in Request.requests) {\n    if (Request.requests.hasOwnProperty(i)) {\n      Request.requests[i].abort();\n    }\n  }\n}\n"]}