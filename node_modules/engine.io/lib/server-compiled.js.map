{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["\n/**\n * Module dependencies.\n */\n\nvar qs = require('querystring')\n  , parse = require('url').parse\n  , readFileSync = require('fs').readFileSync\n  , crypto = require('crypto')\n  , base64id = require('base64id')\n  , transports = require('./transports')\n  , EventEmitter = require('events').EventEmitter\n  , Socket = require('./socket')\n  , WebSocketServer = require('ws').Server\n  , debug = require('debug')('engine');\n\n/**\n * Module exports.\n */\n\nmodule.exports = Server;\n\n/**\n * Server constructor.\n *\n * @param {Object} options\n * @api public\n */\n\nfunction Server(opts){\n  if (!(this instanceof Server)) {\n    return new Server(opts);\n  }\n\n  this.clients = {};\n  this.clientsCount = 0;\n\n  opts = opts || {};\n  this.pingTimeout = opts.pingTimeout || 60000;\n  this.pingInterval = opts.pingInterval || 25000;\n  this.upgradeTimeout = opts.upgradeTimeout || 10000;\n  this.maxHttpBufferSize = opts.maxHttpBufferSize || 10E7;\n  this.transports = opts.transports || Object.keys(transports);\n  this.allowUpgrades = false !== opts.allowUpgrades;\n  this.allowRequest = opts.allowRequest;\n  this.cookie = false !== opts.cookie ? (opts.cookie || 'io') : false;\n\n  // initialize websocket server\n  if (~this.transports.indexOf('websocket')) {\n    this.ws = new WebSocketServer({ noServer: true, clientTracking: false });\n  }\n}\n\n/**\n * Protocol errors mappings.\n */\n\nServer.errors = {\n  UNKNOWN_TRANSPORT: 0,\n  UNKNOWN_SID: 1,\n  BAD_HANDSHAKE_METHOD: 2,\n  BAD_REQUEST: 3\n};\n\nServer.errorMessages = {\n  0: 'Transport unknown',\n  1: 'Session ID unknown',\n  2: 'Bad handshake method',\n  3: 'Bad request'\n};\n\n/**\n * Inherits from EventEmitter.\n */\n\nServer.prototype.__proto__ = EventEmitter.prototype;\n\n/**\n * Hash of open clients.\n *\n * @api public\n */\n\nServer.prototype.clients;\n\n/**\n * Returns a list of available transports for upgrade given a certain transport.\n *\n * @return {Array}\n * @api public\n */\n\nServer.prototype.upgrades = function(transport){\n  if (!this.allowUpgrades) return [];\n  return transports[transport].upgradesTo || [];\n};\n\n/**\n * Verifies a request.\n *\n * @param {http.ServerRequest}\n * @return {Boolean} whether the request is valid\n * @api private\n */\n\nServer.prototype.verify = function(req, upgrade, fn){\n  // transport check\n  var transport = req._query.transport;\n  if (!~this.transports.indexOf(transport)) {\n    debug('unknown transport \"%s\"', transport);\n    return fn(Server.errors.UNKNOWN_TRANSPORT, false);\n  }\n\n  // sid check\n  var sid = req._query.sid;\n  if (sid) {\n    if (!this.clients.hasOwnProperty(sid))\n      return fn(Server.errors.UNKNOWN_SID, false);\n    if (!upgrade && this.clients[sid].transport.name !== transport) {\n      debug('bad request: unexpected transport without upgrade');\n      return fn(Server.errors.BAD_REQUEST, false);\n    }\n  } else {\n    // handshake is GET only\n    if ('GET' != req.method) return fn(Server.errors.BAD_HANDSHAKE_METHOD, false);\n    if (!this.allowRequest) return fn(null, true);\n    return this.allowRequest(req, fn);\n  }\n\n  fn(null, true);\n};\n\n/**\n * Prepares a request by processing the query string.\n *\n * @api private\n */\n\nServer.prototype.prepare = function(req){\n  // try to leverage pre-existing `req._query` (e.g: from connect)\n  if (!req._query) {\n    req._query = ~req.url.indexOf('?') ? qs.parse(parse(req.url).query) : {};\n  }\n};\n\n/**\n * Closes all clients.\n *\n * @api public\n */\n\nServer.prototype.close = function(){\n  debug('closing all open clients');\n  for (var i in this.clients) {\n    this.clients[i].close();\n  }\n  return this;\n};\n\n/**\n * Handles an Engine.IO HTTP request.\n *\n * @param {http.ServerRequest} request\n * @param {http.ServerResponse|http.OutgoingMessage} response\n * @api public\n */\n\nServer.prototype.handleRequest = function(req, res){\n  debug('handling \"%s\" http request \"%s\"', req.method, req.url);\n  this.prepare(req);\n  req.res = res;\n\n  var self = this;\n  this.verify(req, false, function(err, success) {\n    if (!success) {\n      sendErrorMessage(req, res, err);\n      return;\n    }\n\n    if (req._query.sid) {\n      debug('setting new request for existing client');\n      self.clients[req._query.sid].transport.onRequest(req);\n    } else {\n      self.handshake(req._query.transport, req);\n    }\n  });\n};\n\n/**\n * Sends an Engine.IO Error Message\n *\n * @param {http.ServerResponse} response\n * @param {code} error code\n * @api private\n */\n\n function sendErrorMessage(req, res, code) {\n    var headers = { 'Content-Type': 'application/json' };\n\n    if (req.headers.origin) {\n      headers['Access-Control-Allow-Credentials'] = 'true';\n      headers['Access-Control-Allow-Origin'] = req.headers.origin;\n    } else {\n      headers['Access-Control-Allow-Origin'] = '*';\n    }\n    res.writeHead(400, headers);\n    res.end(JSON.stringify({\n      code: code,\n      message: Server.errorMessages[code]\n    }));\n }\n\n/**\n * Handshakes a new client.\n *\n * @param {String} transport name\n * @param {Object} request object\n * @api private\n */\n\nServer.prototype.handshake = function(transport, req){\n  var id = base64id.generateId();\n\n  debug('handshaking client \"%s\"', id);\n\n  var transportName = transport;\n  try {\n    var transport = new transports[transport](req);\n    if ('polling' == transportName) {\n      transport.maxHttpBufferSize = this.maxHttpBufferSize;\n    }\n\n    if (req._query && req._query.b64) {\n      transport.supportsBinary = false;\n    } else {\n      transport.supportsBinary = true;\n    }\n  }\n  catch (e) {\n    sendErrorMessage(req, req.res, Server.errors.BAD_REQUEST);\n    return;\n  }\n  var socket = new Socket(id, this, transport, req);\n  var self = this;\n\n  if (false !== this.cookie) {\n    transport.on('headers', function(headers){\n      headers['Set-Cookie'] = self.cookie + '=' + id;\n    });\n  }\n\n  transport.onRequest(req);\n\n  this.clients[id] = socket;\n  this.clientsCount++;\n\n  socket.once('close', function(){\n    delete self.clients[id];\n    self.clientsCount--;\n  });\n\n  this.emit('connection', socket);\n};\n\n/**\n * Handles an Engine.IO HTTP Upgrade.\n *\n * @api public\n */\n\nServer.prototype.handleUpgrade = function(req, socket, upgradeHead){\n  this.prepare(req);\n\n  var self = this;\n  this.verify(req, true, function(err, success) {\n    if (!success) {\n      socket.end();\n      return;\n    }\n\n    var head = new Buffer(upgradeHead.length);\n    upgradeHead.copy(head);\n    upgradeHead = null;\n\n    // delegate to ws\n    self.ws.handleUpgrade(req, socket, head, function(conn){\n      self.onWebSocket(req, conn);\n    });\n  });\n};\n\n/**\n * Called upon a ws.io connection.\n *\n * @param {ws.Socket} websocket\n * @api private\n */\n\nServer.prototype.onWebSocket = function(req, socket){\n  if (!transports[req._query.transport].prototype.handlesUpgrades) {\n    debug('transport doesnt handle upgraded requests');\n    socket.close();\n    return;\n  }\n\n  // get client id\n  var id = req._query.sid;\n\n  // keep a reference to the ws.Socket\n  req.websocket = socket;\n\n  if (id) {\n    if (!this.clients[id]) {\n      debug('upgrade attempt for closed client');\n      socket.close();\n    } else if (this.clients[id].upgraded) {\n      debug('transport had already been upgraded');\n      socket.close();\n    } else {\n      debug('upgrading existing transport');\n      var transport = new transports[req._query.transport](req);\n      if (req._query && req._query.b64) {\n        transport.supportsBinary = false;\n      } else {\n        transport.supportsBinary = true;\n      }\n      this.clients[id].maybeUpgrade(transport);\n    }\n  } else {\n    this.handshake(req._query.transport, req);\n  }\n};\n\n/**\n * Captures upgrade requests for a http.Server.\n *\n * @param {http.Server} server\n * @param {Object} options\n * @api public\n */\n\nServer.prototype.attach = function(server, options){\n  var self = this;\n  var options = options || {};\n  var path = (options.path || '/engine.io').replace(/\\/$/, '');\n\n  var destroyUpgrade = (options.destroyUpgrade !== undefined) ? options.destroyUpgrade : true;\n  var destroyUpgradeTimeout = options.destroyUpgradeTimeout || 1000;\n\n  // normalize path\n  path += '/';\n\n  function check (req) {\n    return path == req.url.substr(0, path.length);\n  }\n\n  // cache and clean up listeners\n  var listeners = server.listeners('request').slice(0);\n  server.removeAllListeners('request');\n  server.on('close', self.close.bind(self));\n\n  // add request handler\n  server.on('request', function(req, res){\n    if (check(req)) {\n      debug('intercepting request for path \"%s\"', path);\n      self.handleRequest(req, res);\n    } else {\n      for (var i = 0, l = listeners.length; i < l; i++) {\n        listeners[i].call(server, req, res);\n      }\n    }\n  });\n\n  if(~self.transports.indexOf('websocket')) {\n    server.on('upgrade', function (req, socket, head) {\n      if (check(req)) {\n        self.handleUpgrade(req, socket, head);\n      } else if (false !== options.destroyUpgrade) {\n        // default node behavior is to disconnect when no handlers\n        // but by adding a handler, we prevent that\n        // and if no eio thing handles the upgrade\n        // then the socket needs to die!\n        setTimeout(function() {\n           if (socket.writable && socket.bytesWritten <= 0) {\n             return socket.end();\n           }\n        }, options.destroyUpgradeTimeout);\n      }\n    });\n  }\n};\n"]}