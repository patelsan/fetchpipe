{"version":3,"sources":["socket.js"],"names":[],"mappings":"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","file":"socket-compiled.js","sourcesContent":["/**\n * Module dependencies.\n */\n\nvar EventEmitter = require('events').EventEmitter;\nvar debug = require('debug')('engine:socket');\n\n/**\n * Module exports.\n */\n\nmodule.exports = Socket;\n\n/**\n * Client class (abstract).\n *\n * @api private\n */\n\nfunction Socket (id, server, transport, req) {\n  this.id = id;\n  this.server = server;\n  this.upgraded = false;\n  this.readyState = 'opening';\n  this.writeBuffer = [];\n  this.packetsFn = [];\n  this.sentCallbackFn = [];\n  this.request = req;\n\n  // Cache IP since it might not be in the req later\n  this.remoteAddress = req.connection.remoteAddress;\n\n  this.checkIntervalTimer = null;\n  this.upgradeTimeoutTimer = null;\n  this.pingTimeoutTimer = null;\n\n  this.setTransport(transport);\n  this.onOpen();\n}\n\n/**\n * Inherits from EventEmitter.\n */\n\nSocket.prototype.__proto__ = EventEmitter.prototype;\n\n/**\n * Called upon transport considered open.\n *\n * @api private\n */\n\nSocket.prototype.onOpen = function () {\n  this.readyState = 'open';\n\n  // sends an `open` packet\n  this.transport.sid = this.id;\n  this.sendPacket('open', JSON.stringify({\n      sid: this.id\n    , upgrades: this.getAvailableUpgrades()\n    , pingInterval: this.server.pingInterval\n    , pingTimeout: this.server.pingTimeout\n  }));\n\n  this.emit('open');\n  this.setPingTimeout();\n};\n\n/**\n * Called upon transport packet.\n *\n * @param {Object} packet\n * @api private\n */\n\nSocket.prototype.onPacket = function (packet) {\n  if ('open' == this.readyState) {\n    // export packet event\n    debug('packet');\n    this.emit('packet', packet);\n\n    // Reset ping timeout on any packet, incoming data is a good sign of\n    // other side's liveness\n    this.setPingTimeout();\n\n    switch (packet.type) {\n\n      case 'ping':\n        debug('got ping');\n        this.sendPacket('pong');\n        this.emit('heartbeat');\n        break;\n\n      case 'error':\n        this.onClose('parse error');\n        break;\n\n      case 'message':\n        this.emit('data', packet.data);\n        this.emit('message', packet.data);\n        break;\n    }\n  } else {\n    debug('packet received with closed socket');\n  }\n};\n\n/**\n * Called upon transport error.\n *\n * @param {Error} error object\n * @api private\n */\n\nSocket.prototype.onError = function (err) {\n  debug('transport error');\n  this.onClose('transport error', err);\n};\n\n/**\n * Sets and resets ping timeout timer based on client pings.\n *\n * @api private\n */\n\nSocket.prototype.setPingTimeout = function () {\n  var self = this;\n  clearTimeout(self.pingTimeoutTimer);\n  self.pingTimeoutTimer = setTimeout(function () {\n    self.onClose('ping timeout');\n  }, self.server.pingInterval + self.server.pingTimeout);\n};\n\n/**\n * Attaches handlers for the given transport.\n *\n * @param {Transport} transport\n * @api private\n */\n\nSocket.prototype.setTransport = function (transport) {\n  this.transport = transport;\n  this.transport.once('error', this.onError.bind(this));\n  this.transport.on('packet', this.onPacket.bind(this));\n  this.transport.on('drain', this.flush.bind(this));\n  this.transport.once('close', this.onClose.bind(this, 'transport close'));\n  //this function will manage packet events (also message callbacks)\n  this.setupSendCallback();\n};\n\n/**\n * Upgrades socket to the given transport\n *\n * @param {Transport} transport\n * @api private\n */\n\nSocket.prototype.maybeUpgrade = function (transport) {\n  debug('might upgrade socket transport from \"%s\" to \"%s\"'\n    , this.transport.name, transport.name);\n\n  var self = this;\n\n  // set transport upgrade timer\n  self.upgradeTimeoutTimer = setTimeout(function () {\n    debug('client did not complete upgrade - closing transport');\n    clearInterval(self.checkIntervalTimer);\n    self.checkIntervalTimer = null;\n    if ('open' == transport.readyState) {\n      transport.close();\n    }\n  }, this.server.upgradeTimeout);\n\n  function onPacket(packet){\n    if ('ping' == packet.type && 'probe' == packet.data) {\n      transport.send([{ type: 'pong', data: 'probe' }]);\n      clearInterval(self.checkIntervalTimer);\n      self.checkIntervalTimer = setInterval(check, 100);\n    } else if ('upgrade' == packet.type && self.readyState != 'closed') {\n      debug('got upgrade packet - upgrading');\n      self.upgraded = true;\n      self.clearTransport();\n      self.setTransport(transport);\n      self.emit('upgrade', transport);\n      self.setPingTimeout();\n      self.flush();\n      clearInterval(self.checkIntervalTimer);\n      self.checkIntervalTimer = null;\n      clearTimeout(self.upgradeTimeoutTimer);\n      transport.removeListener('packet', onPacket);\n      if (self.readyState == 'closing') {\n        transport.close(function () {\n          self.onClose('forced close');\n        });\n      }\n    } else {\n      transport.close();\n    }\n  }\n\n  // we force a polling cycle to ensure a fast upgrade\n  function check(){\n    if ('polling' == self.transport.name && self.transport.writable) {\n      debug('writing a noop packet to polling for fast upgrade');\n      self.transport.send([{ type: 'noop' }]);\n    }\n  }\n\n  transport.on('packet', onPacket);\n};\n\n/**\n * Clears listeners and timers associated with current transport.\n *\n * @api private\n */\n\nSocket.prototype.clearTransport = function () {\n  // silence further transport errors and prevent uncaught exceptions\n  this.transport.on('error', function(){\n    debug('error triggered by discarded transport');\n  });\n  clearTimeout(this.pingTimeoutTimer);\n};\n\n/**\n * Called upon transport considered closed.\n * Possible reasons: `ping timeout`, `client error`, `parse error`,\n * `transport error`, `server close`, `transport close`\n */\n\nSocket.prototype.onClose = function (reason, description) {\n  if ('closed' != this.readyState) {\n    clearTimeout(this.pingTimeoutTimer);\n    clearInterval(this.checkIntervalTimer);\n    this.checkIntervalTimer = null;\n    clearTimeout(this.upgradeTimeoutTimer);\n    var self = this;\n    // clean writeBuffer in next tick, so developers can still\n    // grab the writeBuffer on 'close' event\n    process.nextTick(function() {\n      self.writeBuffer = [];\n    });\n    this.packetsFn = [];\n    this.sentCallbackFn = [];\n    this.clearTransport();\n    this.readyState = 'closed';\n    this.emit('close', reason, description);\n  }\n};\n\n/**\n * Setup and manage send callback\n *\n * @api private\n */\n\nSocket.prototype.setupSendCallback = function () {\n  var self = this;\n  //the message was sent successfully, execute the callback\n  this.transport.on('drain', function() {\n    if (self.sentCallbackFn.length > 0) {\n      var seqFn = self.sentCallbackFn.splice(0,1)[0];\n      if ('function' == typeof seqFn) {\n        debug('executing send callback');\n        seqFn(self.transport);\n      } else if (Array.isArray(seqFn)) {\n        debug('executing batch send callback');\n        for (var l = seqFn.length, i = 0; i < l; i++) {\n          if ('function' == typeof seqFn[i]) {\n            seqFn[i](self.transport);\n          }\n        }\n      }\n    }\n  });\n};\n\n/**\n * Sends a message packet.\n *\n * @param {String} message\n * @param {Function} callback\n * @return {Socket} for chaining\n * @api public\n */\n\nSocket.prototype.send =\nSocket.prototype.write = function(data, callback){\n  this.sendPacket('message', data, callback);\n  return this;\n};\n\n/**\n * Sends a packet.\n *\n * @param {String} packet type\n * @param {String} optional, data\n * @api private\n */\n\nSocket.prototype.sendPacket = function (type, data, callback) {\n  if ('closing' != this.readyState) {\n    debug('sending packet \"%s\" (%s)', type, data);\n\n    var packet = { type: type };\n    if (data) packet.data = data;\n\n    // exports packetCreate event\n    this.emit('packetCreate', packet);\n\n    this.writeBuffer.push(packet);\n\n    //add send callback to object\n    this.packetsFn.push(callback);\n\n    this.flush();\n  }\n};\n\n/**\n * Attempts to flush the packets buffer.\n *\n * @api private\n */\n\nSocket.prototype.flush = function () {\n  if ('closed' != this.readyState && this.transport.writable\n    && this.writeBuffer.length) {\n    debug('flushing buffer to transport');\n    this.emit('flush', this.writeBuffer);\n    this.server.emit('flush', this, this.writeBuffer);\n    var wbuf = this.writeBuffer;\n    this.writeBuffer = [];\n    if (!this.transport.supportsFraming) {\n      this.sentCallbackFn.push(this.packetsFn);\n    } else {\n      this.sentCallbackFn.push.apply(this.sentCallbackFn, this.packetsFn);\n    }\n    this.packetsFn = [];\n    this.transport.send(wbuf);\n    this.emit('drain');\n    this.server.emit('drain', this);\n  }\n};\n\n/**\n * Get available upgrades for this socket.\n *\n * @api private\n */\n\nSocket.prototype.getAvailableUpgrades = function () {\n  var availableUpgrades = [];\n  var allUpgrades = this.server.upgrades(this.transport.name);\n  for (var i = 0, l = allUpgrades.length; i < l; ++i) {\n    var upg = allUpgrades[i];\n    if (this.server.transports.indexOf(upg) != -1) {\n      availableUpgrades.push(upg);\n    }\n  }\n  return availableUpgrades;\n};\n\n/**\n * Closes the socket and underlying transport.\n *\n * @return {Socket} for chaining\n * @api public\n */\n\nSocket.prototype.close = function () {\n  if ('open' != this.readyState) return;\n\n  this.readyState = 'closing';\n\n  if (this.writeBuffer.length) {\n    this.once('drain', this.closeTransport.bind(this));\n    return;\n  }\n\n  this.closeTransport();\n};\n\n/**\n * Closes the underlying transport.\n *\n * @api private\n */\n\nSocket.prototype.closeTransport = function () {\n  this.transport.close(this.onClose.bind(this, 'forced close'));\n};\n"]}