{"version":3,"sources":["testpackage.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AAEb,MAAM,CAAC,OAAO,GAAG,OAAO,GAAG,WAAW,CAAC;;AAEvC,OAAO,CAAC,KAAK,GAAG,wCAAwC,CAAC;;AAEzD,IAAI,EAAE,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC;AACvB,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;AAC3B,IAAI,GAAG,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC5B,IAAI,WAAW,GAAG,EAAE,CAAC,MAAM,IAAI,IAAI,CAAC,MAAM,CAAC;AAC3C,IAAI,UAAU,GAAG,OAAO,CAAC,sBAAsB,CAAC,CAAC;AACjD,IAAI,UAAU,GAAG,OAAO,CAAC,iBAAiB,CAAC,CAAC;AAC5C,IAAI,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,gBAAgB,CAAC;AAC1C,IAAI,IAAI,GAAG,OAAO,CAAC,MAAM,CAAC,CAAC;;AAE3B,SAAS,WAAW,CAAC,GAAG,EAAE,IAAI,EAAE,QAAQ,EAAE;AACtC,QAAI,YAAY,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,YAAY,CAAC,gBAAgB,CAAC,CAAC,CAAC;AACjE,QAAI,IAAI,GAAG,UAAU,CAAC,QAAQ,CAAC,YAAY,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC;AACvD,QAAI,OAAO,GAAG,IAAI,CAAC,cAAc,CAAC;AAClC,eAAW,CAAC,OAAO,EAAE,UAAS,KAAK,EAAE;AACjC,YAAI,CAAC,KAAK,EAAE;AACR,mBAAO,QAAQ,CAAC,IAAI,KAAK,CAAC,8BAA8B,GAAG,OAAO,GAAG,4CAA4C,CAAC,CAAC,CAAC;SACvH;AACD,YAAI,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC;AAC1B,YAAI,MAAM,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;AACjC,YAAI,SAAS,GAAG,OAAO,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC,CAAC;AAC/D,iBAAS,WAAW,CAAC,KAAK,EAAE;;;AAGxB,iBAAK,CAAC,KAAK,CAAC,IAAI,IAAI,AAAC,KAAK,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,GAAI,QAAQ,CAAC,MAAM,EAAC,CAAC,CAAC,CAAC;AAClE,eAAG,CAAC,IAAI,CAAC,SAAS,EAAC,YAAY,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC;SACjD;AACD,cAAM,CAAC,EAAE,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;AAC7B,iBAAS,CAAC,EAAE,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;AAChC,iBAAS,CAAC,EAAE,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;AACnC,iBAAS,CAAC,EAAE,CAAC,KAAK,EAAE,UAAS,GAAG,EAAE;AAC9B,gBAAI,GAAG,EAAE,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAC;AAC9B,sBAAU,CAAC,GAAG,EAAC,IAAI,EAAC,UAAS,GAAG,EAAE;AAC9B,oBAAI,GAAG,EAAE;AACL,2BAAO,QAAQ,CAAC,GAAG,CAAC,CAAC;iBACxB,MAAM;AACH,2BAAO,CAAC,GAAG,CAAC,GAAG,GAAC,YAAY,CAAC,IAAI,GAAC,yBAAyB,CAAC,CAAC;AAC7D,2BAAO,QAAQ,EAAE,CAAC;iBACrB;aACJ,CAAC,CAAC;SACN,CAAC,CAAC;AACH,YAAI,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;KAC9C,CAAC,CAAC;CACN","file":"testpackage-compiled.js","sourcesContent":["\"use strict\";\n\nmodule.exports = exports = testpackage;\n\nexports.usage = 'Tests that the staged package is valid';\n\nvar fs = require('fs');\nvar path = require('path');\nvar log = require('npmlog');\nvar existsAsync = fs.exists || path.exists;\nvar versioning = require('./util/versioning.js');\nvar testbinary = require('./testbinary.js');\nvar read = require('fs').createReadStream;\nvar zlib = require('zlib');\n\nfunction testpackage(gyp, argv, callback) {\n    var package_json = JSON.parse(fs.readFileSync('./package.json'));\n    var opts = versioning.evaluate(package_json, gyp.opts);\n    var tarball = opts.staged_tarball;\n    existsAsync(tarball, function(found) {\n        if (!found) {\n            return callback(new Error(\"Cannot test package because \" + tarball + \" missing: run `node-pre-gyp package` first\"));\n        }\n        var to = opts.module_path;\n        var gunzip = zlib.createGunzip();\n        var extracter = require('tar').Extract({ path: to, strip: 1 });\n        function filter_func(entry) {\n            // ensure directories are +x\n            // https://github.com/mapnik/node-mapnik/issues/262\n            entry.props.mode |= (entry.props.mode >>> 2) & parseInt('0111',8);\n            log.info('install','unpacking ' + entry.path);\n        }\n        gunzip.on('error', callback);\n        extracter.on('error', callback);\n        extracter.on('entry', filter_func);\n        extracter.on('end', function(err) {\n            if (err) return callback(err);\n            testbinary(gyp,argv,function(err) {\n                if (err) {\n                    return callback(err);\n                } else {\n                    console.log('['+package_json.name+'] Package appears valid');\n                    return callback();\n                }\n            });\n        });\n        read(tarball).pipe(gunzip).pipe(extracter);\n    });\n}\n"]}