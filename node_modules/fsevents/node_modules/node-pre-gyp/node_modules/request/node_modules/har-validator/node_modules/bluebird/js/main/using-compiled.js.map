{"version":3,"sources":["using.js"],"names":[],"mappings":"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","file":"using-compiled.js","sourcesContent":["\"use strict\";\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise,\n    createContext) {\n    var TypeError = require(\"./errors.js\").TypeError;\n    var inherits = require(\"./util.js\").inherits;\n    var PromiseInspection = Promise.PromiseInspection;\n\n    function inspectionMapper(inspections) {\n        var len = inspections.length;\n        for (var i = 0; i < len; ++i) {\n            var inspection = inspections[i];\n            if (inspection.isRejected()) {\n                return Promise.reject(inspection.error());\n            }\n            inspections[i] = inspection._settledValue;\n        }\n        return inspections;\n    }\n\n    function thrower(e) {\n        setTimeout(function(){throw e;}, 0);\n    }\n\n    function castPreservingDisposable(thenable) {\n        var maybePromise = tryConvertToPromise(thenable);\n        if (maybePromise !== thenable &&\n            typeof thenable._isDisposable === \"function\" &&\n            typeof thenable._getDisposer === \"function\" &&\n            thenable._isDisposable()) {\n            maybePromise._setDisposable(thenable._getDisposer());\n        }\n        return maybePromise;\n    }\n    function dispose(resources, inspection) {\n        var i = 0;\n        var len = resources.length;\n        var ret = Promise.defer();\n        function iterator() {\n            if (i >= len) return ret.resolve();\n            var maybePromise = castPreservingDisposable(resources[i++]);\n            if (maybePromise instanceof Promise &&\n                maybePromise._isDisposable()) {\n                try {\n                    maybePromise = tryConvertToPromise(\n                        maybePromise._getDisposer().tryDispose(inspection),\n                        resources.promise);\n                } catch (e) {\n                    return thrower(e);\n                }\n                if (maybePromise instanceof Promise) {\n                    return maybePromise._then(iterator, thrower,\n                                              null, null, null);\n                }\n            }\n            iterator();\n        }\n        iterator();\n        return ret.promise;\n    }\n\n    function disposerSuccess(value) {\n        var inspection = new PromiseInspection();\n        inspection._settledValue = value;\n        inspection._bitField = 268435456;\n        return dispose(this, inspection).thenReturn(value);\n    }\n\n    function disposerFail(reason) {\n        var inspection = new PromiseInspection();\n        inspection._settledValue = reason;\n        inspection._bitField = 134217728;\n        return dispose(this, inspection).thenThrow(reason);\n    }\n\n    function Disposer(data, promise, context) {\n        this._data = data;\n        this._promise = promise;\n        this._context = context;\n    }\n\n    Disposer.prototype.data = function () {\n        return this._data;\n    };\n\n    Disposer.prototype.promise = function () {\n        return this._promise;\n    };\n\n    Disposer.prototype.resource = function () {\n        if (this.promise().isFulfilled()) {\n            return this.promise().value();\n        }\n        return null;\n    };\n\n    Disposer.prototype.tryDispose = function(inspection) {\n        var resource = this.resource();\n        var context = this._context;\n        if (context !== undefined) context._pushContext();\n        var ret = resource !== null\n            ? this.doDispose(resource, inspection) : null;\n        if (context !== undefined) context._popContext();\n        this._promise._unsetDisposable();\n        this._data = null;\n        return ret;\n    };\n\n    Disposer.isDisposer = function (d) {\n        return (d != null &&\n                typeof d.resource === \"function\" &&\n                typeof d.tryDispose === \"function\");\n    };\n\n    function FunctionDisposer(fn, promise, context) {\n        this.constructor$(fn, promise, context);\n    }\n    inherits(FunctionDisposer, Disposer);\n\n    FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n        var fn = this.data();\n        return fn.call(resource, resource, inspection);\n    };\n\n    function maybeUnwrapDisposer(value) {\n        if (Disposer.isDisposer(value)) {\n            this.resources[this.index]._setDisposable(value);\n            return value.promise();\n        }\n        return value;\n    }\n\n    Promise.using = function () {\n        var len = arguments.length;\n        if (len < 2) return apiRejection(\n                        \"you must pass at least 2 arguments to Promise.using\");\n        var fn = arguments[len - 1];\n        if (typeof fn !== \"function\") return apiRejection(\"fn must be a function\\u000a\\u000a    See http://goo.gl/916lJJ\\u000a\");\n\n        var input;\n        var spreadArgs = true;\n        if (len === 2 && Array.isArray(arguments[0])) {\n            input = arguments[0];\n            len = input.length;\n            spreadArgs = false;\n        } else {\n            input = arguments;\n            len--;\n        }\n        var resources = new Array(len);\n        for (var i = 0; i < len; ++i) {\n            var resource = input[i];\n            if (Disposer.isDisposer(resource)) {\n                var disposer = resource;\n                resource = resource.promise();\n                resource._setDisposable(disposer);\n            } else {\n                var maybePromise = tryConvertToPromise(resource);\n                if (maybePromise instanceof Promise) {\n                    resource =\n                        maybePromise._then(maybeUnwrapDisposer, null, null, {\n                            resources: resources,\n                            index: i\n                    }, undefined);\n                }\n            }\n            resources[i] = resource;\n        }\n\n        var promise = Promise.settle(resources)\n            .then(inspectionMapper)\n            .then(function(vals) {\n                promise._pushContext();\n                var ret;\n                try {\n                    ret = spreadArgs\n                        ? fn.apply(undefined, vals) : fn.call(undefined,  vals);\n                } finally {\n                    promise._popContext();\n                }\n                return ret;\n            })\n            ._then(\n                disposerSuccess, disposerFail, undefined, resources, undefined);\n        resources.promise = promise;\n        return promise;\n    };\n\n    Promise.prototype._setDisposable = function (disposer) {\n        this._bitField = this._bitField | 262144;\n        this._disposer = disposer;\n    };\n\n    Promise.prototype._isDisposable = function () {\n        return (this._bitField & 262144) > 0;\n    };\n\n    Promise.prototype._getDisposer = function () {\n        return this._disposer;\n    };\n\n    Promise.prototype._unsetDisposable = function () {\n        this._bitField = this._bitField & (~262144);\n        this._disposer = undefined;\n    };\n\n    Promise.prototype.disposer = function (fn) {\n        if (typeof fn === \"function\") {\n            return new FunctionDisposer(fn, this, createContext());\n        }\n        throw new TypeError();\n    };\n\n};\n"]}