{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["\"use strict\"\r\n\r\nvar debug = require('debug')('tar-pack')\r\nvar uidNumber = require('uid-number')\r\nvar rm = require('rimraf')\r\nvar tar = require('tar')\r\nvar once = require('once')\r\nvar fstream = require('fstream')\r\nvar packer = require('fstream-ignore')\r\n\r\nvar PassThrough = require('stream').PassThrough || require('readable-stream').PassThrough\r\nvar zlib = require('zlib')\r\nvar path = require('path')\r\nvar fs\r\ntry {\r\n  fs = require('graceful-fs')\r\n} catch (ex) {\r\n  fs = require('fs')\r\n}\r\n\r\nvar win32 = process.platform === 'win32'\r\nvar myUid = process.getuid && process.getuid()\r\nvar myGid = process.getgid && process.getgid()\r\n\r\nif (process.env.SUDO_UID && myUid === 0) {\r\n  if (!isNaN(process.env.SUDO_UID)) myUid = +process.env.SUDO_UID\r\n  if (!isNaN(process.env.SUDO_GID)) myGid = +process.env.SUDO_GID\r\n}\r\n\r\nexports.pack = pack\r\nexports.unpack = unpack\r\n\r\nfunction pack(folder, options) {\r\n  options = options || {}\r\n  if (typeof folder === 'string') {\r\n\r\n    var filter = options.filter || function (entry) { return true; }\r\n\r\n    folder = packer({\r\n      path: folder,\r\n      type: 'Directory',\r\n      isDirectory: true,\r\n      ignoreFiles: options.ignoreFiles || ['.gitignore'],\r\n      filter: function (entry) { // {path, basename, dirname, type} (type is \"Directory\" or \"File\")\r\n        var basename = entry.basename\r\n        // some files are *never* allowed under any circumstances\r\n        // these files should always be either temporary files or\r\n        // version control related files\r\n        if (basename === '.git' || basename === '.lock-wscript' || basename.match(/^\\.wafpickle-[0-9]+$/) ||\r\n            basename === 'CVS' || basename === '.svn' || basename === '.hg' || basename.match(/^\\..*\\.swp$/) ||\r\n            basename === '.DS_Store' ||  basename.match(/^\\._/)) {\r\n          return false\r\n        }\r\n        //custom excludes\r\n        return filter(entry)\r\n      }\r\n    })\r\n  }\r\n  // By default, npm includes some proprietary attributes in the\r\n  // package tarball.  This is sane, and allowed by the spec.\r\n  // However, npm *itself* excludes these from its own package,\r\n  // so that it can be more easily bootstrapped using old and\r\n  // non-compliant tar implementations.\r\n  var tarPack = tar.Pack({ noProprietary: options.noProprietary || false })\r\n  var gzip = zlib.Gzip()\r\n\r\n  folder\r\n    .on('error', function (er) {\r\n      if (er) debug('Error reading folder')\r\n      return gzip.emit('error', er)\r\n    })\r\n  tarPack\r\n    .on('error', function (er) {\r\n      if (er) debug('tar creation error')\r\n      gzip.emit('error', er)\r\n    })\r\n  return folder.pipe(tarPack).pipe(gzip)\r\n}\r\n\r\nfunction unpack(unpackTarget, options, cb) {\r\n  if (typeof options === 'function' && cb === undefined) cb = options, options = undefined\r\n\r\n  var tarball = new PassThrough()\r\n  if (typeof cb === 'function') {\r\n    cb = once(cb)\r\n    tarball.on('error', cb)\r\n    tarball.on('close', function () {\r\n      cb()\r\n    })\r\n  }\r\n\r\n  var parent = path.dirname(unpackTarget)\r\n  var base = path.basename(unpackTarget)\r\n\r\n  options = options || {}\r\n  var gid = options.gid || null\r\n  var uid = options.uid || null\r\n  var dMode = options.dmode || 0x0777 //npm.modes.exec\r\n  var fMode = options.fmode || 0x0666 //npm.modes.file\r\n  var defaultName = options.defaultName || (options.defaultName === false ? false : 'index.js')\r\n\r\n  // figure out who we're supposed to be, if we're not pretending\r\n  // to be a specific user.\r\n  if (options.unsafe && !win32) {\r\n    uid = myUid\r\n    gid = myGid\r\n  }\r\n\r\n  var pending = 2\r\n  uidNumber(uid, gid, function (er, uid, gid) {\r\n    if (er) {\r\n      tarball.emit('error', er)\r\n      return tarball.end()\r\n    }\r\n    if (0 === --pending) next()\r\n  })\r\n  rm(unpackTarget, function (er) {\r\n    if (er) {\r\n      tarball.emit('error', er)\r\n      return tarball.end()\r\n    }\r\n    if (0 === --pending) next()\r\n  })\r\n  function next() {\r\n    // gzip {tarball} --decompress --stdout \\\r\n    //   | tar -mvxpf - --strip-components=1 -C {unpackTarget}\r\n    gunzTarPerm(tarball, unpackTarget, dMode, fMode, uid, gid, defaultName)\r\n  }\r\n  return tarball\r\n}\r\n\r\n\r\nfunction gunzTarPerm(tarball, target, dMode, fMode, uid, gid, defaultName) {\r\n  debug('modes %j', [dMode.toString(8), fMode.toString(8)])\r\n\r\n  function fixEntry(entry) {\r\n    debug('fixEntry %j', entry.path)\r\n    // never create things that are user-unreadable,\r\n    // or dirs that are user-un-listable. Only leads to headaches.\r\n    var originalMode = entry.mode = entry.mode || entry.props.mode\r\n    entry.mode = entry.mode | (entry.type === 'Directory' ? dMode : fMode)\r\n    entry.props.mode = entry.mode\r\n    if (originalMode !== entry.mode) {\r\n      debug('modified mode %j', [entry.path, originalMode, entry.mode])\r\n    }\r\n\r\n    // if there's a specific owner uid/gid that we want, then set that\r\n    if (!win32 &&  typeof uid === 'number' && typeof gid === 'number') {\r\n      entry.props.uid = entry.uid = uid\r\n      entry.props.gid = entry.gid = gid\r\n    }\r\n  }\r\n\r\n  var extractOpts = { type: 'Directory', path: target, strip: 1 }\r\n\r\n  if (!win32 && typeof uid === 'number' && typeof gid === 'number') {\r\n    extractOpts.uid = uid\r\n    extractOpts.gid = gid\r\n  }\r\n\r\n  extractOpts.filter = function () {\r\n    // symbolic links are not allowed in packages.\r\n    if (this.type.match(/^.*Link$/)) {\r\n      debug('excluding symbolic link: ' + this.path.substr(target.length + 1) + ' -> ' + this.linkpath)\r\n      return false\r\n    }\r\n    return true\r\n  }\r\n\r\n\r\n  type(tarball, function (err, type) {\r\n    if (err) return tarball.emit('error', err)\r\n    var strm = tarball\r\n    if (type === 'gzip') {\r\n      strm = strm.pipe(zlib.Unzip())\r\n      strm.on('error', function (er) {\r\n          if (er) debug('unzip error')\r\n          tarball.emit('error', er)\r\n        })\r\n      type = 'tar'\r\n    }\r\n    if (type === 'tar') {\r\n      strm\r\n        .pipe(tar.Extract(extractOpts))\r\n        .on('entry', fixEntry)\r\n        .on('error', function (er) {\r\n          if (er) debug('untar error')\r\n          tarball.emit('error', er)\r\n        })\r\n        .on('close', function () {\r\n          tarball.emit('close')\r\n        })\r\n      return\r\n    }\r\n    if (type === 'naked-file' && defaultName) {\r\n      var jsOpts = { path: path.resolve(target, defaultName) }\r\n\r\n      if (!win32 && typeof uid === 'number' && typeof gid === 'number') {\r\n        jsOpts.uid = uid\r\n        jsOpts.gid = gid\r\n      }\r\n\r\n      strm\r\n        .pipe(fstream.Writer(jsOpts))\r\n        .on('error', function (er) {\r\n          if (er) debug('copy error')\r\n          tarball.emit('error', er)\r\n        })\r\n        .on('close', function () {\r\n          tarball.emit('close')\r\n        })\r\n      return\r\n    }\r\n\r\n    return cb(new Error('Unrecognised package type'));\r\n  })\r\n}\r\n\r\nfunction type(stream, callback) {\r\n  stream.on('error', handle)\r\n  stream.on('data', parse)\r\n  function handle(err) {\r\n    stream.removeListener('data', parse)\r\n    stream.removeListener('error', handle)\r\n  }\r\n  function parse(chunk) {\r\n    // detect what it is.\r\n    // Then, depending on that, we'll figure out whether it's\r\n    // a single-file module, gzipped tarball, or naked tarball.\r\n\r\n    // gzipped files all start with 1f8b08\r\n    if (chunk[0] === 0x1F && chunk[1] === 0x8B && chunk[2] === 0x08) {\r\n      callback(null, 'gzip')\r\n    } else if (chunk.toString().match(/^package\\/\\u0000/)) {\r\n      // note, this will only pick up on tarballs with a root directory called package\r\n      callback(null, 'tar')\r\n    } else {\r\n      callback(null, 'naked-file')\r\n    }\r\n\r\n    // now un-hook, and re-emit the chunk\r\n    stream.removeListener('data', parse)\r\n    stream.removeListener('error', handle)\r\n    stream.unshift(chunk)\r\n  }\r\n}"]}