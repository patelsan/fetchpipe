{"version":3,"sources":["file-reader.js"],"names":[],"mappings":"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","file":"file-reader-compiled.js","sourcesContent":["// Basically just a wrapper around an fs.ReadStream\n\nmodule.exports = FileReader\n\nvar fs = require(\"graceful-fs\")\n  , fstream = require(\"../fstream.js\")\n  , Reader = fstream.Reader\n  , inherits = require(\"inherits\")\n  , mkdir = require(\"mkdirp\")\n  , Reader = require(\"./reader.js\")\n  , EOF = {EOF: true}\n  , CLOSE = {CLOSE: true}\n\ninherits(FileReader, Reader)\n\nfunction FileReader (props) {\n  // console.error(\"    FR create\", props.path, props.size, new Error().stack)\n  var me = this\n  if (!(me instanceof FileReader)) throw new Error(\n    \"FileReader must be called as constructor.\")\n\n  // should already be established as a File type\n  // XXX Todo: preserve hardlinks by tracking dev+inode+nlink,\n  // with a HardLinkReader class.\n  if (!((props.type === \"Link\" && props.Link) ||\n        (props.type === \"File\" && props.File))) {\n    throw new Error(\"Non-file type \"+ props.type)\n  }\n\n  me._buffer = []\n  me._bytesEmitted = 0\n  Reader.call(me, props)\n}\n\nFileReader.prototype._getStream = function () {\n  var me = this\n    , stream = me._stream = fs.createReadStream(me._path, me.props)\n\n  if (me.props.blksize) {\n    stream.bufferSize = me.props.blksize\n  }\n\n  stream.on(\"open\", me.emit.bind(me, \"open\"))\n\n  stream.on(\"data\", function (c) {\n    // console.error(\"\\t\\t%d %s\", c.length, me.basename)\n    me._bytesEmitted += c.length\n    // no point saving empty chunks\n    if (!c.length) return\n    else if (me._paused || me._buffer.length) {\n      me._buffer.push(c)\n      me._read()\n    } else me.emit(\"data\", c)\n  })\n\n  stream.on(\"end\", function () {\n    if (me._paused || me._buffer.length) {\n      // console.error(\"FR Buffering End\", me._path)\n      me._buffer.push(EOF)\n      me._read()\n    } else {\n      me.emit(\"end\")\n    }\n\n    if (me._bytesEmitted !== me.props.size) {\n      me.error(\"Didn't get expected byte count\\n\"+\n               \"expect: \"+me.props.size + \"\\n\" +\n               \"actual: \"+me._bytesEmitted)\n    }\n  })\n\n  stream.on(\"close\", function () {\n    if (me._paused || me._buffer.length) {\n      // console.error(\"FR Buffering Close\", me._path)\n      me._buffer.push(CLOSE)\n      me._read()\n    } else {\n      // console.error(\"FR close 1\", me._path)\n      me.emit(\"close\")\n    }\n  })\n\n  me._read()\n}\n\nFileReader.prototype._read = function () {\n  var me = this\n  // console.error(\"FR _read\", me._path)\n  if (me._paused) {\n    // console.error(\"FR _read paused\", me._path)\n    return\n  }\n\n  if (!me._stream) {\n    // console.error(\"FR _getStream calling\", me._path)\n    return me._getStream()\n  }\n\n  // clear out the buffer, if there is one.\n  if (me._buffer.length) {\n    // console.error(\"FR _read has buffer\", me._buffer.length, me._path)\n    var buf = me._buffer\n    for (var i = 0, l = buf.length; i < l; i ++) {\n      var c = buf[i]\n      if (c === EOF) {\n        // console.error(\"FR Read emitting buffered end\", me._path)\n        me.emit(\"end\")\n      } else if (c === CLOSE) {\n        // console.error(\"FR Read emitting buffered close\", me._path)\n        me.emit(\"close\")\n      } else {\n        // console.error(\"FR Read emitting buffered data\", me._path)\n        me.emit(\"data\", c)\n      }\n\n      if (me._paused) {\n        // console.error(\"FR Read Re-pausing at \"+i, me._path)\n        me._buffer = buf.slice(i)\n        return\n      }\n    }\n    me._buffer.length = 0\n  }\n  // console.error(\"FR _read done\")\n  // that's about all there is to it.\n}\n\nFileReader.prototype.pause = function (who) {\n  var me = this\n  // console.error(\"FR Pause\", me._path)\n  if (me._paused) return\n  who = who || me\n  me._paused = true\n  if (me._stream) me._stream.pause()\n  me.emit(\"pause\", who)\n}\n\nFileReader.prototype.resume = function (who) {\n  var me = this\n  // console.error(\"FR Resume\", me._path)\n  if (!me._paused) return\n  who = who || me\n  me.emit(\"resume\", who)\n  me._paused = false\n  if (me._stream) me._stream.resume()\n  me._read()\n}\n"]}