{"version":3,"sources":["reader.js"],"names":[],"mappings":"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","file":"reader-compiled.js","sourcesContent":["\nmodule.exports = Reader\n\nvar fs = require(\"graceful-fs\")\n  , Stream = require(\"stream\").Stream\n  , inherits = require(\"inherits\")\n  , path = require(\"path\")\n  , getType = require(\"./get-type.js\")\n  , hardLinks = Reader.hardLinks = {}\n  , Abstract = require(\"./abstract.js\")\n\n// Must do this *before* loading the child classes\ninherits(Reader, Abstract)\n\nvar DirReader = require(\"./dir-reader.js\")\n  , FileReader = require(\"./file-reader.js\")\n  , LinkReader = require(\"./link-reader.js\")\n  , SocketReader = require(\"./socket-reader.js\")\n  , ProxyReader = require(\"./proxy-reader.js\")\n\nfunction Reader (props, currentStat) {\n  var me = this\n  if (!(me instanceof Reader)) return new Reader(props, currentStat)\n\n  if (typeof props === \"string\") {\n    props = { path: props }\n  }\n\n  if (!props.path) {\n    me.error(\"Must provide a path\", null, true)\n  }\n\n  // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n\n  var type\n    , ClassType\n\n  if (props.type && typeof props.type === \"function\") {\n    type = props.type\n    ClassType = type\n  } else {\n    type = getType(props)\n    ClassType = Reader\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat)\n    props[type] = true\n    props.type = type\n  }\n\n  switch (type) {\n    case \"Directory\":\n      ClassType = DirReader\n      break\n\n    case \"Link\":\n      // XXX hard links are just files.\n      // However, it would be good to keep track of files' dev+inode\n      // and nlink values, and create a HardLinkReader that emits\n      // a linkpath value of the original copy, so that the tar\n      // writer can preserve them.\n      // ClassType = HardLinkReader\n      // break\n\n    case \"File\":\n      ClassType = FileReader\n      break\n\n    case \"SymbolicLink\":\n      ClassType = LinkReader\n      break\n\n    case \"Socket\":\n      ClassType = SocketReader\n      break\n\n    case null:\n      ClassType = ProxyReader\n      break\n  }\n\n  if (!(me instanceof ClassType)) {\n    return new ClassType(props)\n  }\n\n  Abstract.call(me)\n\n  me.readable = true\n  me.writable = false\n\n  me.type = type\n  me.props = props\n  me.depth = props.depth = props.depth || 0\n  me.parent = props.parent || null\n  me.root = props.root || (props.parent && props.parent.root) || me\n\n  me._path = me.path = path.resolve(props.path)\n  if (process.platform === \"win32\") {\n    me.path = me._path = me.path.replace(/\\?/g, \"_\")\n    if (me._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      me._swallowErrors = true\n      //if (me._path.indexOf(\" \") === -1) {\n        me._path = \"\\\\\\\\?\\\\\" + me.path.replace(/\\//g, \"\\\\\")\n      //}\n    }\n  }\n  me.basename = props.basename = path.basename(me.path)\n  me.dirname = props.dirname = path.dirname(me.path)\n\n  // these have served their purpose, and are now just noisy clutter\n  props.parent = props.root = null\n\n  // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n  me.size = props.size\n  me.filter = typeof props.filter === \"function\" ? props.filter : null\n  if (props.sort === \"alpha\") props.sort = alphasort\n\n  // start the ball rolling.\n  // this will stat the thing, and then call me._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n  me._stat(currentStat)\n}\n\nfunction alphasort (a, b) {\n  return a === b ? 0\n       : a.toLowerCase() > b.toLowerCase() ? 1\n       : a.toLowerCase() < b.toLowerCase() ? -1\n       : a > b ? 1\n       : -1\n}\n\nReader.prototype._stat = function (currentStat) {\n  var me = this\n    , props = me.props\n    , stat = props.follow ? \"stat\" : \"lstat\"\n  // console.error(\"Reader._stat\", me._path, currentStat)\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat))\n  else fs[stat](me._path, statCb)\n\n\n  function statCb (er, props_) {\n    // console.error(\"Reader._stat, statCb\", me._path, props_, props_.nlink)\n    if (er) return me.error(er)\n\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k]\n    })\n\n    // if it's not the expected size, then abort here.\n    if (undefined !== me.size && props.size !== me.size) {\n      return me.error(\"incorrect size\")\n    }\n    me.size = props.size\n\n    var type = getType(props)\n    var handleHardlinks = props.hardlinks !== false\n    \n    // special little thing for handling hardlinks.\n    if (handleHardlinks && type !== \"Directory\" && props.nlink && props.nlink > 1) {\n      var k = props.dev + \":\" + props.ino\n      // console.error(\"Reader has nlink\", me._path, k)\n      if (hardLinks[k] === me._path || !hardLinks[k]) hardLinks[k] = me._path\n      else {\n        // switch into hardlink mode.\n        type = me.type = me.props.type = \"Link\"\n        me.Link = me.props.Link = true\n        me.linkpath = me.props.linkpath = hardLinks[k]\n        // console.error(\"Hardlink detected, switching mode\", me._path, me.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n        me._stat = me._read = LinkReader.prototype._read\n      }\n    }\n\n    if (me.type && me.type !== type) {\n      me.error(\"Unexpected type: \" + type)\n    }\n\n    // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n    if (me.filter) {\n      var who = me._proxy || me\n      // special handling for ProxyReaders\n      if (!me.filter.call(who, who, props)) {\n        if (!me._disowned) {\n          me.abort()\n          me.emit(\"end\")\n          me.emit(\"close\")\n        }\n        return\n      }\n    }\n\n    // last chance to abort or disown before the flow starts!\n    var events = [\"_stat\", \"stat\", \"ready\"]\n    var e = 0\n    ;(function go () {\n      if (me._aborted) {\n        me.emit(\"end\")\n        me.emit(\"close\")\n        return\n      }\n\n      if (me._paused && me.type !== \"Directory\") {\n        me.once(\"resume\", go)\n        return\n      }\n\n      var ev = events[e ++]\n      if (!ev) {\n        return me._read()\n      }\n      me.emit(ev, props)\n      go()\n    })()\n  }\n}\n\nReader.prototype.pipe = function (dest, opts) {\n  var me = this\n  if (typeof dest.add === \"function\") {\n    // piping to a multi-compatible, and we've got directory entries.\n    me.on(\"entry\", function (entry) {\n      var ret = dest.add(entry)\n      if (false === ret) {\n        me.pause()\n      }\n    })\n  }\n\n  // console.error(\"R Pipe apply Stream Pipe\")\n  return Stream.prototype.pipe.apply(this, arguments)\n}\n\nReader.prototype.pause = function (who) {\n  this._paused = true\n  who = who || this\n  this.emit(\"pause\", who)\n  if (this._stream) this._stream.pause(who)\n}\n\nReader.prototype.resume = function (who) {\n  this._paused = false\n  who = who || this\n  this.emit(\"resume\", who)\n  if (this._stream) this._stream.resume(who)\n  this._read()\n}\n\nReader.prototype._read = function () {\n  this.error(\"Cannot read unknown type: \"+this.type)\n}\n\n"]}