{"version":3,"sources":["entry-writer.js"],"names":[],"mappings":"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","file":"entry-writer-compiled.js","sourcesContent":["module.exports = EntryWriter\n\nvar tar = require(\"../tar.js\")\n  , TarHeader = require(\"./header.js\")\n  , Entry = require(\"./entry.js\")\n  , inherits = require(\"inherits\")\n  , BlockStream = require(\"block-stream\")\n  , ExtendedHeaderWriter\n  , Stream = require(\"stream\").Stream\n  , EOF = {}\n\ninherits(EntryWriter, Stream)\n\nfunction EntryWriter (props) {\n  var me = this\n\n  if (!(me instanceof EntryWriter)) {\n    return new EntryWriter(props)\n  }\n\n  Stream.apply(this)\n\n  me.writable = true\n  me.readable = true\n\n  me._stream = new BlockStream(512)\n\n  me._stream.on(\"data\", function (c) {\n    me.emit(\"data\", c)\n  })\n\n  me._stream.on(\"drain\", function () {\n    me.emit(\"drain\")\n  })\n\n  me._stream.on(\"end\", function () {\n    me.emit(\"end\")\n    me.emit(\"close\")\n  })\n\n  me.props = props\n  if (props.type === \"Directory\") {\n    props.size = 0\n  }\n  props.ustar = \"ustar\\0\"\n  props.ustarver = \"00\"\n  me.path = props.path\n\n  me._buffer = []\n  me._didHeader = false\n  me._meta = false\n\n  me.on(\"pipe\", function () {\n    me._process()\n  })\n}\n\nEntryWriter.prototype.write = function (c) {\n  // console.error(\".. ew write\")\n  if (this._ended) return this.emit(\"error\", new Error(\"write after end\"))\n  this._buffer.push(c)\n  this._process()\n  this._needDrain = this._buffer.length > 0\n  return !this._needDrain\n}\n\nEntryWriter.prototype.end = function (c) {\n  // console.error(\".. ew end\")\n  if (c) this._buffer.push(c)\n  this._buffer.push(EOF)\n  this._ended = true\n  this._process()\n  this._needDrain = this._buffer.length > 0\n}\n\nEntryWriter.prototype.pause = function () {\n  // console.error(\".. ew pause\")\n  this._paused = true\n  this.emit(\"pause\")\n}\n\nEntryWriter.prototype.resume = function () {\n  // console.error(\".. ew resume\")\n  this._paused = false\n  this.emit(\"resume\")\n  this._process()\n}\n\nEntryWriter.prototype.add = function (entry) {\n  // console.error(\".. ew add\")\n  if (!this.parent) return this.emit(\"error\", new Error(\"no parent\"))\n\n  // make sure that the _header and such is emitted, and clear out\n  // the _currentEntry link on the parent.\n  if (!this._ended) this.end()\n\n  return this.parent.add(entry)\n}\n\nEntryWriter.prototype._header = function () {\n  // console.error(\".. ew header\")\n  if (this._didHeader) return\n  this._didHeader = true\n\n  var headerBlock = TarHeader.encode(this.props)\n\n  if (this.props.needExtended && !this._meta) {\n    var me = this\n\n    ExtendedHeaderWriter = ExtendedHeaderWriter ||\n      require(\"./extended-header-writer.js\")\n\n    ExtendedHeaderWriter(this.props)\n      .on(\"data\", function (c) {\n        me.emit(\"data\", c)\n      })\n      .on(\"error\", function (er) {\n        me.emit(\"error\", er)\n      })\n      .end()\n  }\n\n  // console.error(\".. .. ew headerBlock emitting\")\n  this.emit(\"data\", headerBlock)\n  this.emit(\"header\")\n}\n\nEntryWriter.prototype._process = function () {\n  // console.error(\".. .. ew process\")\n  if (!this._didHeader && !this._meta) {\n    this._header()\n  }\n\n  if (this._paused || this._processing) {\n    // console.error(\".. .. .. paused=%j, processing=%j\", this._paused, this._processing)\n    return\n  }\n\n  this._processing = true\n\n  var buf = this._buffer\n  for (var i = 0; i < buf.length; i ++) {\n    // console.error(\".. .. .. i=%d\", i)\n\n    var c = buf[i]\n\n    if (c === EOF) this._stream.end()\n    else this._stream.write(c)\n\n    if (this._paused) {\n      // console.error(\".. .. .. paused mid-emission\")\n      this._processing = false\n      if (i < buf.length) {\n        this._needDrain = true\n        this._buffer = buf.slice(i + 1)\n      }\n      return\n    }\n  }\n\n  // console.error(\".. .. .. emitted\")\n  this._buffer.length = 0\n  this._processing = false\n\n  // console.error(\".. .. .. emitting drain\")\n  this.emit(\"drain\")\n}\n\nEntryWriter.prototype.destroy = function () {}\n"]}