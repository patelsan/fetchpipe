{"version":3,"sources":["file-writer.js"],"names":[],"mappings":"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","file":"file-writer-compiled.js","sourcesContent":["module.exports = FileWriter\n\nvar fs = require('graceful-fs')\nvar Writer = require('./writer.js')\nvar inherits = require('inherits')\nvar EOF = {}\n\ninherits(FileWriter, Writer)\n\nfunction FileWriter (props) {\n  var self = this\n  if (!(self instanceof FileWriter)) {\n    throw new Error('FileWriter must be called as constructor.')\n  }\n\n  // should already be established as a File type\n  if (props.type !== 'File' || !props.File) {\n    throw new Error('Non-file type ' + props.type)\n  }\n\n  self._buffer = []\n  self._bytesWritten = 0\n\n  Writer.call(this, props)\n}\n\nFileWriter.prototype._create = function () {\n  var self = this\n  if (self._stream) return\n\n  var so = {}\n  if (self.props.flags) so.flags = self.props.flags\n  so.mode = Writer.filemode\n  if (self._old && self._old.blksize) so.bufferSize = self._old.blksize\n\n  self._stream = fs.createWriteStream(self._path, so)\n\n  self._stream.on('open', function () {\n    // console.error(\"FW open\", self._buffer, self._path)\n    self.ready = true\n    self._buffer.forEach(function (c) {\n      if (c === EOF) self._stream.end()\n      else self._stream.write(c)\n    })\n    self.emit('ready')\n    // give this a kick just in case it needs it.\n    self.emit('drain')\n  })\n\n  self._stream.on('error', function (er) { self.emit('error', er) })\n\n  self._stream.on('drain', function () { self.emit('drain') })\n\n  self._stream.on('close', function () {\n    // console.error('\\n\\nFW Stream Close', self._path, self.size)\n    self._finish()\n  })\n}\n\nFileWriter.prototype.write = function (c) {\n  var self = this\n\n  self._bytesWritten += c.length\n\n  if (!self.ready) {\n    if (!Buffer.isBuffer(c) && typeof c !== 'string') {\n      throw new Error('invalid write data')\n    }\n    self._buffer.push(c)\n    return false\n  }\n\n  var ret = self._stream.write(c)\n  // console.error('\\t-- fw wrote, _stream says', ret, self._stream._queue.length)\n\n  // allow 2 buffered writes, because otherwise there's just too\n  // much stop and go bs.\n  if (ret === false && self._stream._queue) {\n    return self._stream._queue.length <= 2\n  } else {\n    return ret\n  }\n}\n\nFileWriter.prototype.end = function (c) {\n  var self = this\n\n  if (c) self.write(c)\n\n  if (!self.ready) {\n    self._buffer.push(EOF)\n    return false\n  }\n\n  return self._stream.end()\n}\n\nFileWriter.prototype._finish = function () {\n  var self = this\n  if (typeof self.size === 'number' && self._bytesWritten !== self.size) {\n    self.error(\n      'Did not get expected byte count.\\n' +\n      'expect: ' + self.size + '\\n' +\n      'actual: ' + self._bytesWritten)\n  }\n  Writer.prototype._finish.call(self)\n}\n"]}