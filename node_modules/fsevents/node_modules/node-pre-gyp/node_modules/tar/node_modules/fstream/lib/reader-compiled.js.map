{"version":3,"sources":["reader.js"],"names":[],"mappings":"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","file":"reader-compiled.js","sourcesContent":["module.exports = Reader\n\nvar fs = require('graceful-fs')\nvar Stream = require('stream').Stream\nvar inherits = require('inherits')\nvar path = require('path')\nvar getType = require('./get-type.js')\nvar hardLinks = Reader.hardLinks = {}\nvar Abstract = require('./abstract.js')\n\n// Must do this *before* loading the child classes\ninherits(Reader, Abstract)\n\nvar LinkReader = require('./link-reader.js')\n\nfunction Reader (props, currentStat) {\n  var self = this\n  if (!(self instanceof Reader)) return new Reader(props, currentStat)\n\n  if (typeof props === 'string') {\n    props = { path: props }\n  }\n\n  if (!props.path) {\n    self.error('Must provide a path', null, true)\n  }\n\n  // polymorphism.\n  // call fstream.Reader(dir) to get a DirReader object, etc.\n  // Note that, unlike in the Writer case, ProxyReader is going\n  // to be the *normal* state of affairs, since we rarely know\n  // the type of a file prior to reading it.\n\n  var type\n  var ClassType\n\n  if (props.type && typeof props.type === 'function') {\n    type = props.type\n    ClassType = type\n  } else {\n    type = getType(props)\n    ClassType = Reader\n  }\n\n  if (currentStat && !type) {\n    type = getType(currentStat)\n    props[type] = true\n    props.type = type\n  }\n\n  switch (type) {\n    case 'Directory':\n      ClassType = require('./dir-reader.js')\n      break\n\n    case 'Link':\n    // XXX hard links are just files.\n    // However, it would be good to keep track of files' dev+inode\n    // and nlink values, and create a HardLinkReader that emits\n    // a linkpath value of the original copy, so that the tar\n    // writer can preserve them.\n    // ClassType = HardLinkReader\n    // break\n\n    case 'File':\n      ClassType = require('./file-reader.js')\n      break\n\n    case 'SymbolicLink':\n      ClassType = LinkReader\n      break\n\n    case 'Socket':\n      ClassType = require('./socket-reader.js')\n      break\n\n    case null:\n      ClassType = require('./proxy-reader.js')\n      break\n  }\n\n  if (!(self instanceof ClassType)) {\n    return new ClassType(props)\n  }\n\n  Abstract.call(self)\n\n  self.readable = true\n  self.writable = false\n\n  self.type = type\n  self.props = props\n  self.depth = props.depth = props.depth || 0\n  self.parent = props.parent || null\n  self.root = props.root || (props.parent && props.parent.root) || self\n\n  self._path = self.path = path.resolve(props.path)\n  if (process.platform === 'win32') {\n    self.path = self._path = self.path.replace(/\\?/g, '_')\n    if (self._path.length >= 260) {\n      // how DOES one create files on the moon?\n      // if the path has spaces in it, then UNC will fail.\n      self._swallowErrors = true\n      // if (self._path.indexOf(\" \") === -1) {\n      self._path = '\\\\\\\\?\\\\' + self.path.replace(/\\//g, '\\\\')\n    // }\n    }\n  }\n  self.basename = props.basename = path.basename(self.path)\n  self.dirname = props.dirname = path.dirname(self.path)\n\n  // these have served their purpose, and are now just noisy clutter\n  props.parent = props.root = null\n\n  // console.error(\"\\n\\n\\n%s setting size to\", props.path, props.size)\n  self.size = props.size\n  self.filter = typeof props.filter === 'function' ? props.filter : null\n  if (props.sort === 'alpha') props.sort = alphasort\n\n  // start the ball rolling.\n  // this will stat the thing, and then call self._read()\n  // to start reading whatever it is.\n  // console.error(\"calling stat\", props.path, currentStat)\n  self._stat(currentStat)\n}\n\nfunction alphasort (a, b) {\n  return a === b ? 0\n    : a.toLowerCase() > b.toLowerCase() ? 1\n      : a.toLowerCase() < b.toLowerCase() ? -1\n        : a > b ? 1\n          : -1\n}\n\nReader.prototype._stat = function (currentStat) {\n  var self = this\n  var props = self.props\n  var stat = props.follow ? 'stat' : 'lstat'\n  // console.error(\"Reader._stat\", self._path, currentStat)\n  if (currentStat) process.nextTick(statCb.bind(null, null, currentStat))\n  else fs[stat](self._path, statCb)\n\n  function statCb (er, props_) {\n    // console.error(\"Reader._stat, statCb\", self._path, props_, props_.nlink)\n    if (er) return self.error(er)\n\n    Object.keys(props_).forEach(function (k) {\n      props[k] = props_[k]\n    })\n\n    // if it's not the expected size, then abort here.\n    if (undefined !== self.size && props.size !== self.size) {\n      return self.error('incorrect size')\n    }\n    self.size = props.size\n\n    var type = getType(props)\n    var handleHardlinks = props.hardlinks !== false\n\n    // special little thing for handling hardlinks.\n    if (handleHardlinks && type !== 'Directory' && props.nlink && props.nlink > 1) {\n      var k = props.dev + ':' + props.ino\n      // console.error(\"Reader has nlink\", self._path, k)\n      if (hardLinks[k] === self._path || !hardLinks[k]) {\n        hardLinks[k] = self._path\n      } else {\n        // switch into hardlink mode.\n        type = self.type = self.props.type = 'Link'\n        self.Link = self.props.Link = true\n        self.linkpath = self.props.linkpath = hardLinks[k]\n        // console.error(\"Hardlink detected, switching mode\", self._path, self.linkpath)\n        // Setting __proto__ would arguably be the \"correct\"\n        // approach here, but that just seems too wrong.\n        self._stat = self._read = LinkReader.prototype._read\n      }\n    }\n\n    if (self.type && self.type !== type) {\n      self.error('Unexpected type: ' + type)\n    }\n\n    // if the filter doesn't pass, then just skip over this one.\n    // still have to emit end so that dir-walking can move on.\n    if (self.filter) {\n      var who = self._proxy || self\n      // special handling for ProxyReaders\n      if (!self.filter.call(who, who, props)) {\n        if (!self._disowned) {\n          self.abort()\n          self.emit('end')\n          self.emit('close')\n        }\n        return\n      }\n    }\n\n    // last chance to abort or disown before the flow starts!\n    var events = ['_stat', 'stat', 'ready']\n    var e = 0\n    ;(function go () {\n      if (self._aborted) {\n        self.emit('end')\n        self.emit('close')\n        return\n      }\n\n      if (self._paused && self.type !== 'Directory') {\n        self.once('resume', go)\n        return\n      }\n\n      var ev = events[e++]\n      if (!ev) {\n        return self._read()\n      }\n      self.emit(ev, props)\n      go()\n    })()\n  }\n}\n\nReader.prototype.pipe = function (dest) {\n  var self = this\n  if (typeof dest.add === 'function') {\n    // piping to a multi-compatible, and we've got directory entries.\n    self.on('entry', function (entry) {\n      var ret = dest.add(entry)\n      if (ret === false) {\n        self.pause()\n      }\n    })\n  }\n\n  // console.error(\"R Pipe apply Stream Pipe\")\n  return Stream.prototype.pipe.apply(this, arguments)\n}\n\nReader.prototype.pause = function (who) {\n  this._paused = true\n  who = who || this\n  this.emit('pause', who)\n  if (this._stream) this._stream.pause(who)\n}\n\nReader.prototype.resume = function (who) {\n  this._paused = false\n  who = who || this\n  this.emit('resume', who)\n  if (this._stream) this._stream.resume(who)\n  this._read()\n}\n\nReader.prototype._read = function () {\n  this.error('Cannot read unknown type: ' + this.type)\n}\n"]}