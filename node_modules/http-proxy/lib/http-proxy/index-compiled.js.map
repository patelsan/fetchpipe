{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["var httpProxy = exports,\n    extend    = require('util')._extend,\n    parse_url = require('url').parse,\n    EE3       = require('eventemitter3'),\n    http      = require('http'),\n    https     = require('https'),\n    web       = require('./passes/web-incoming'),\n    ws        = require('./passes/ws-incoming');\n\nhttpProxy.Server = ProxyServer;\n\n/**\n * Returns a function that creates the loader for\n * either `ws` or `web`'s  passes.\n *\n * Examples:\n *\n *    httpProxy.createRightProxy('ws')\n *    // => [Function]\n *\n * @param {String} Type Either 'ws' or 'web'\n *Â \n * @return {Function} Loader Function that when called returns an iterator for the right passes\n *\n * @api private\n */\n\nfunction createRightProxy(type) {\n\n  return function(options) {\n    return function(req, res /*, [head], [opts] */) {\n      var passes = (type === 'ws') ? this.wsPasses : this.webPasses,\n          args = [].slice.call(arguments),\n          cntr = args.length - 1,\n          head, cbl;\n\n      /* optional args parse begin */\n      if(typeof args[cntr] === 'function') {\n        cbl = args[cntr];\n\n        cntr--;\n      }\n\n      if(\n        !(args[cntr] instanceof Buffer) &&\n        args[cntr] !== res\n      ) {\n        //Copy global options\n        options = extend({}, options);\n        //Overwrite with request options\n        extend(options, args[cntr]);\n\n        cntr--;\n      }\n\n      if(args[cntr] instanceof Buffer) {\n        head = args[cntr];\n      }\n\n      /* optional args parse end */\n\n      ['target', 'forward'].forEach(function(e) {\n        if (typeof options[e] === 'string')\n          options[e] = parse_url(options[e]);\n      });\n\n      if (!options.target && !options.forward) {\n        return this.emit('error', new Error('Must provide a proper URL as target'));\n      }\n\n      for(var i=0; i < passes.length; i++) {\n        /**\n         * Call of passes functions\n         * pass(req, res, options, head)\n         *\n         * In WebSockets case the `res` variable\n         * refer to the connection socket\n         * pass(req, socket, options, head)\n         */\n        if(passes[i](req, res, options, head, this, cbl)) { // passes can return a truthy value to halt the loop\n          break;\n        }\n      }\n    };\n  };\n}\nhttpProxy.createRightProxy = createRightProxy;\n\nfunction ProxyServer(options) {\n  EE3.call(this);\n\n  options = options || {};\n  options.prependPath = options.prependPath === false ? false : true;\n\n  this.web = this.proxyRequest           = createRightProxy('web')(options);\n  this.ws  = this.proxyWebsocketRequest  = createRightProxy('ws')(options);\n  this.options = options;\n\n  this.webPasses = Object.keys(web).map(function(pass) {\n    return web[pass];\n  });\n\n  this.wsPasses = Object.keys(ws).map(function(pass) {\n    return ws[pass];\n  });\n\n  this.on('error', this.onError, this);\n\n}\n\nrequire('util').inherits(ProxyServer, EE3);\n\nProxyServer.prototype.onError = function (err) {\n  //\n  // Remark: Replicate node core behavior using EE3\n  // so we force people to handle their own errors\n  //\n  if(this.listeners('error').length === 1) {\n    throw err;\n  }\n};\n\nProxyServer.prototype.listen = function(port, hostname) {\n  var self    = this,\n      closure = function(req, res) { self.web(req, res); };\n\n  this._server  = this.options.ssl ?\n    https.createServer(this.options.ssl, closure) :\n    http.createServer(closure);\n\n  if(this.options.ws) {\n    this._server.on('upgrade', function(req, socket, head) { self.ws(req, socket, head); });\n  }\n\n  this._server.listen(port, hostname);\n\n  return this;\n};\n\nProxyServer.prototype.close = function(callback) {\n  var self = this;\n  if (this._server) {\n    this._server.close(done);\n  }\n\n  // Wrap callback to nullify server after all open connections are closed.\n  function done() {\n    self._server = null;\n    if (callback) {\n      callback.apply(null, arguments);\n    }\n  };\n};\n\nProxyServer.prototype.before = function(type, passName, callback) {\n  if (type !== 'ws' && type !== 'web') {\n    throw new Error('type must be `web` or `ws`');\n  }\n  var passes = (type === 'ws') ? this.wsPasses : this.webPasses,\n      i = false;\n\n  passes.forEach(function(v, idx) {\n    if(v.name === passName) i = idx;\n  })\n\n  if(i === false) throw new Error('No such pass');\n\n  passes.splice(i, 0, callback);\n};\nProxyServer.prototype.after = function(type, passName, callback) {\n  if (type !== 'ws' && type !== 'web') {\n    throw new Error('type must be `web` or `ws`');\n  }\n  var passes = (type === 'ws') ? this.wsPasses : this.webPasses,\n      i = false;\n\n  passes.forEach(function(v, idx) {\n    if(v.name === passName) i = idx;\n  })\n\n  if(i === false) throw new Error('No such pass');\n\n  passes.splice(i++, 0, callback);\n};\n"]}