{"version":3,"sources":["browser.js"],"names":[],"mappings":"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","file":"browser-compiled.js","sourcesContent":["var helper = require('./helper')\nvar events = require('./events')\nvar logger = require('./logger')\n\nvar Result = require('./browser_result')\n\n// The browser is ready to execute tests.\nvar READY = 1\n\n// The browser is executing the tests/\nvar EXECUTING = 2\n\n// The browser is not executing, but temporarily disconnected (waiting for reconnecting).\nvar READY_DISCONNECTED = 3\n\n// The browser is executing the tests, but temporarily disconnect (waiting for reconnecting).\nvar EXECUTING_DISCONNECTED = 4\n\n// The browser got permanently disconnected (being removed from the collection and destroyed).\nvar DISCONNECTED = 5\n\nvar Browser = function (id, fullName, /* capturedBrowsers */ collection, emitter, socket, timer,\n  /* config.browserDisconnectTimeout */ disconnectDelay,\n  /* config.browserNoActivityTimeout */ noActivityTimeout) {\n  var name = helper.browserFullNameToShort(fullName)\n  var log = logger.create(name)\n  var activeSockets = [socket]\n  var activeSocketsIds = function () {\n    return activeSockets.map(function (s) {\n      return s.id\n    }).join(', ')\n  }\n\n  var self = this\n  var pendingDisconnect\n  var disconnect = function (reason) {\n    self.state = DISCONNECTED\n    self.disconnectsCount++\n    log.warn('Disconnected (%d times)' + (reason || ''), self.disconnectsCount)\n    collection.remove(self)\n  }\n\n  var noActivityTimeoutId\n  var refreshNoActivityTimeout = noActivityTimeout ? function () {\n    clearNoActivityTimeout()\n    noActivityTimeoutId = timer.setTimeout(function () {\n      self.lastResult.totalTimeEnd()\n      self.lastResult.disconnected = true\n      disconnect(', because no message in ' + noActivityTimeout + ' ms.')\n      emitter.emit('browser_complete', self)\n    }, noActivityTimeout)\n  } : function () {}\n\n  var clearNoActivityTimeout = noActivityTimeout ? function () {\n    if (noActivityTimeoutId) {\n      timer.clearTimeout(noActivityTimeoutId)\n      noActivityTimeoutId = null\n    }\n  } : function () {}\n\n  this.id = id\n  this.fullName = fullName\n  this.name = name\n  this.state = READY\n  this.lastResult = new Result()\n  this.disconnectsCount = 0\n\n  this.init = function () {\n    collection.add(this)\n\n    events.bindAll(this, socket)\n\n    log.info('Connected on socket %s with id %s', socket.id, id)\n\n    // TODO(vojta): move to collection\n    emitter.emit('browsers_change', collection)\n\n    emitter.emit('browser_register', this)\n  }\n\n  this.isReady = function () {\n    return this.state === READY\n  }\n\n  this.toString = function () {\n    return this.name\n  }\n\n  this.onKarmaError = function (error) {\n    if (this.isReady()) {\n      return\n    }\n\n    this.lastResult.error = true\n    emitter.emit('browser_error', this, error)\n\n    refreshNoActivityTimeout()\n  }\n\n  this.onInfo = function (info) {\n    if (this.isReady()) {\n      return\n    }\n\n    // TODO(vojta): remove\n    if (helper.isDefined(info.dump)) {\n      emitter.emit('browser_log', this, info.dump, 'dump')\n    }\n\n    if (helper.isDefined(info.log)) {\n      emitter.emit('browser_log', this, info.log, info.type)\n    }\n\n    refreshNoActivityTimeout()\n  }\n\n  this.onStart = function (info) {\n    this.lastResult = new Result()\n    this.lastResult.total = info.total\n\n    if (info.total === null) {\n      log.warn('Adapter did not report total number of specs.')\n    }\n\n    emitter.emit('browser_start', this, info)\n    refreshNoActivityTimeout()\n  }\n\n  this.onComplete = function (result) {\n    if (this.isReady()) {\n      return\n    }\n\n    this.state = READY\n    this.lastResult.totalTimeEnd()\n\n    if (!this.lastResult.success) {\n      this.lastResult.error = true\n    }\n\n    emitter.emit('browsers_change', collection)\n    emitter.emit('browser_complete', this, result)\n\n    clearNoActivityTimeout()\n  }\n\n  this.onDisconnect = function (_, disconnectedSocket) {\n    activeSockets.splice(activeSockets.indexOf(disconnectedSocket), 1)\n\n    if (activeSockets.length) {\n      log.debug('Disconnected %s, still have %s', disconnectedSocket.id, activeSocketsIds())\n      return\n    }\n\n    if (this.state === READY) {\n      disconnect()\n    } else if (this.state === EXECUTING) {\n      log.debug('Disconnected during run, waiting %sms for reconnecting.', disconnectDelay)\n      this.state = EXECUTING_DISCONNECTED\n\n      pendingDisconnect = timer.setTimeout(function () {\n        self.lastResult.totalTimeEnd()\n        self.lastResult.disconnected = true\n        disconnect()\n        emitter.emit('browser_complete', self)\n      }, disconnectDelay)\n\n      clearNoActivityTimeout()\n    }\n  }\n\n  this.reconnect = function (newSocket) {\n    if (this.state === EXECUTING_DISCONNECTED) {\n      this.state = EXECUTING\n      log.debug('Reconnected on %s.', newSocket.id)\n    } else if (this.state === EXECUTING || this.state === READY) {\n      log.debug('New connection %s (already have %s)', newSocket.id, activeSocketsIds())\n    } else if (this.state === DISCONNECTED) {\n      this.state = READY\n      log.info('Connected on socket %s with id %s', newSocket.id, this.id)\n      collection.add(this)\n\n      // TODO(vojta): move to collection\n      emitter.emit('browsers_change', collection)\n\n      emitter.emit('browser_register', this)\n    }\n\n    var exists = activeSockets.some(function (s) {\n      return s.id === newSocket.id\n    })\n    if (!exists) {\n      activeSockets.push(newSocket)\n      events.bindAll(this, newSocket)\n    }\n\n    if (pendingDisconnect) {\n      timer.clearTimeout(pendingDisconnect)\n    }\n\n    refreshNoActivityTimeout()\n  }\n\n  this.onResult = function (result) {\n    if (result.length) {\n      return result.forEach(this.onResult, this)\n    }\n\n    // ignore - probably results from last run (after server disconnecting)\n    if (this.isReady()) {\n      return\n    }\n\n    this.lastResult.add(result)\n\n    emitter.emit('spec_complete', this, result)\n    refreshNoActivityTimeout()\n  }\n\n  this.serialize = function () {\n    return {\n      id: this.id,\n      name: this.name,\n      isReady: this.state === READY\n    }\n  }\n\n  this.execute = function (config) {\n    activeSockets.forEach(function (socket) {\n      socket.emit('execute', config)\n    })\n\n    this.state = EXECUTING\n    refreshNoActivityTimeout()\n  }\n}\n\nBrowser.STATE_READY = READY\nBrowser.STATE_EXECUTING = EXECUTING\nBrowser.STATE_READY_DISCONNECTED = READY_DISCONNECTED\nBrowser.STATE_EXECUTING_DISCONNECTED = EXECUTING_DISCONNECTED\nBrowser.STATE_DISCONNECTED = DISCONNECTED\n\nmodule.exports = Browser\n"]}