{"version":3,"sources":["launcher.js"],"names":[],"mappings":"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","file":"launcher-compiled.js","sourcesContent":["var log = require('./logger').create('launcher')\nvar Promise = require('bluebird')\n\nvar baseDecorator = require('./launchers/base').decoratorFactory\nvar captureTimeoutDecorator = require('./launchers/capture_timeout').decoratorFactory\nvar retryDecorator = require('./launchers/retry').decoratorFactory\nvar processDecorator = require('./launchers/process').decoratorFactory\n\n// TODO(vojta): remove once nobody uses it\nvar baseBrowserDecoratorFactory = function (baseLauncherDecorator, captureTimeoutLauncherDecorator,\n  retryLauncherDecorator, processLauncherDecorator) {\n  return function (launcher) {\n    baseLauncherDecorator(launcher)\n    captureTimeoutLauncherDecorator(launcher)\n    retryLauncherDecorator(launcher)\n    processLauncherDecorator(launcher)\n  }\n}\n\nvar Launcher = function (emitter, injector) {\n  var browsers = []\n  var lastStartTime\n\n  var getBrowserById = function (id) {\n    for (var i = 0; i < browsers.length; i++) {\n      if (browsers[i].id === id) {\n        return browsers[i]\n      }\n    }\n\n    return null\n  }\n\n  this.launch = function (names, protocol, hostname, port, urlRoot) {\n    var browser\n    var url = protocol + '//' + hostname + ':' + port + urlRoot\n\n    lastStartTime = Date.now()\n\n    names.forEach(function (name) {\n      var locals = {\n        id: ['value', Launcher.generateId()],\n        name: ['value', name],\n        baseLauncherDecorator: ['factory', baseDecorator],\n        captureTimeoutLauncherDecorator: ['factory', captureTimeoutDecorator],\n        retryLauncherDecorator: ['factory', retryDecorator],\n        processLauncherDecorator: ['factory', processDecorator],\n        baseBrowserDecorator: ['factory', baseBrowserDecoratorFactory]\n      }\n\n      // TODO(vojta): determine script from name\n      if (name.indexOf('/') !== -1) {\n        name = 'Script'\n      }\n\n      try {\n        browser = injector.createChild([locals], ['launcher:' + name]).get('launcher:' + name)\n      } catch (e) {\n        if (e.message.indexOf('No provider for \"launcher:' + name + '\"') !== -1) {\n          log.warn('Can not load \"%s\", it is not registered!\\n  ' +\n            'Perhaps you are missing some plugin?', name)\n        } else {\n          log.warn('Can not load \"%s\"!\\n  ' + e.stack, name)\n        }\n\n        return\n      }\n\n      // TODO(vojta): remove in v1.0 (BC for old launchers)\n      if (!browser.forceKill) {\n        browser.forceKill = function () {\n          var self = this\n\n          return new Promise(function (resolve) {\n            self.kill(resolve)\n          })\n        }\n\n        browser.restart = function () {\n          var self = this\n          this.kill(function () {\n            self.start(url)\n          })\n        }\n      }\n\n      log.info('Starting browser %s', browser.name)\n      browser.start(url)\n      browsers.push(browser)\n    })\n\n    return browsers\n  }\n\n  this.launch.$inject = ['config.browsers', 'config.protocol', 'config.hostname', 'config.port', 'config.urlRoot']\n\n  this.kill = function (id, callback) {\n    var browser = getBrowserById(id)\n    callback = callback || function () {}\n\n    if (!browser) {\n      process.nextTick(callback)\n      return false\n    }\n\n    browser.forceKill().then(callback)\n    return true\n  }\n\n  this.restart = function (id) {\n    var browser = getBrowserById(id)\n\n    if (!browser) {\n      return false\n    }\n\n    browser.restart()\n    return true\n  }\n\n  this.killAll = function (callback) {\n    log.debug('Disconnecting all browsers')\n\n    var remaining = 0\n    var finish = function () {\n      remaining--\n      if (!remaining && callback) {\n        callback()\n      }\n    }\n\n    if (!browsers.length) {\n      return process.nextTick(callback)\n    }\n\n    browsers.forEach(function (browser) {\n      remaining++\n      browser.forceKill().then(finish)\n    })\n  }\n\n  this.areAllCaptured = function () {\n    return !browsers.some(function (browser) {\n      return !browser.isCaptured()\n    })\n  }\n\n  this.markCaptured = function (id) {\n    browsers.forEach(function (browser) {\n      if (browser.id === id) {\n        browser.markCaptured()\n        log.debug('%s (id %s) captured in %d secs', browser.name, browser.id,\n          (Date.now() - lastStartTime) / 1000)\n      }\n    })\n  }\n\n  // register events\n  emitter.on('exit', this.killAll)\n}\n\nLauncher.$inject = ['emitter', 'injector']\n\nLauncher.generateId = function () {\n  return '' + Math.floor(Math.random() * 100000000)\n}\n\n// PUBLISH\nexports.Launcher = Launcher\n"]}