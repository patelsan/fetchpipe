{"version":3,"sources":["common.js"],"names":[],"mappings":"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","file":"common-compiled.js","sourcesContent":["/**\n * This module contains some common helpers shared between middlewares\n */\n\nvar mime = require('mime')\nvar log = require('../logger').create('web-server')\n\nvar PromiseContainer = function () {\n  var promise\n\n  this.then = function (success, error) {\n    return promise.then(success).catch(error)\n  }\n\n  this.set = function (newPromise) {\n    promise = newPromise\n  }\n}\n\nvar serve404 = function (response, path) {\n  log.warn('404: ' + path)\n  response.writeHead(404)\n  return response.end('NOT FOUND')\n}\n\nvar createServeFile = function (fs, directory) {\n  var cache = Object.create(null)\n\n  return function (filepath, response, transform, content, doNotCache) {\n    var responseData\n\n    if (directory) {\n      filepath = directory + filepath\n    }\n\n    if (!content && cache[filepath]) {\n      content = cache[filepath]\n    }\n\n    // serve from cache\n    if (content && !doNotCache) {\n      response.setHeader('Content-Type', mime.lookup(filepath, 'text/plain'))\n\n      // call custom transform fn to transform the data\n      responseData = transform && transform(content) || content\n\n      response.writeHead(200)\n\n      log.debug('serving (cached): ' + filepath)\n      return response.end(responseData)\n    }\n\n    return fs.readFile(filepath, function (error, data) {\n      if (error) {\n        return serve404(response, filepath)\n      }\n\n      if (!doNotCache) {\n        cache[filepath] = data.toString()\n      }\n\n      response.setHeader('Content-Type', mime.lookup(filepath, 'text/plain'))\n\n      // call custom transform fn to transform the data\n      responseData = transform && transform(data.toString()) || data\n\n      response.writeHead(200)\n\n      log.debug('serving: ' + filepath)\n      return response.end(responseData)\n    })\n  }\n}\n\nvar setNoCacheHeaders = function (response) {\n  response.setHeader('Cache-Control', 'no-cache')\n  response.setHeader('Pragma', 'no-cache')\n  response.setHeader('Expires', (new Date(0)).toString())\n}\n\nvar setHeavyCacheHeaders = function (response) {\n  response.setHeader('Cache-Control', 'public, max-age=31536000')\n}\n\n// PUBLIC API\nexports.PromiseContainer = PromiseContainer\nexports.createServeFile = createServeFile\nexports.setNoCacheHeaders = setNoCacheHeaders\nexports.setHeavyCacheHeaders = setHeavyCacheHeaders\nexports.serve404 = serve404\n"]}