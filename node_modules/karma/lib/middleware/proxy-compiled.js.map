{"version":3,"sources":["proxy.js"],"names":[],"mappings":"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","file":"proxy-compiled.js","sourcesContent":["var url = require('url')\nvar httpProxy = require('http-proxy')\n\nvar log = require('../logger').create('proxy')\nvar _ = require('../helper')._\n\nvar parseProxyConfig = function (proxies, config) {\n  var endsWithSlash = function (str) {\n    return str.substr(-1) === '/'\n  }\n\n  if (!proxies) {\n    return []\n  }\n\n  return _.sortBy(_.map(proxies, function (proxyUrl, proxyPath) {\n    var proxyDetails = url.parse(proxyUrl)\n    var pathname = proxyDetails.pathname\n\n    // normalize the proxies config\n    // should we move this to lib/config.js ?\n    if (endsWithSlash(proxyPath) && !endsWithSlash(proxyUrl)) {\n      log.warn('proxy \"%s\" normalized to \"%s\"', proxyUrl, proxyUrl + '/')\n      proxyUrl += '/'\n      pathname += '/'\n    }\n\n    if (!endsWithSlash(proxyPath) && endsWithSlash(proxyUrl)) {\n      log.warn('proxy \"%s\" normalized to \"%s\"', proxyPath, proxyPath + '/')\n      proxyPath += '/'\n    }\n\n    if (pathname === '/' && !endsWithSlash(proxyUrl)) {\n      pathname = ''\n    }\n\n    var hostname = proxyDetails.hostname || config.hostname\n    var port = proxyDetails.port || config.port ||\n      (proxyDetails.protocol === 'https:' ? '443' : '80')\n    var https = proxyDetails.protocol === 'https:'\n\n    var proxy = httpProxy.createProxyServer({\n      target: {\n        host: hostname,\n        port: port,\n        https: https\n      },\n      xfwd: true,\n      secure: config.proxyValidateSSL\n    })\n\n    proxy.on('error', function proxyError (err, req, res) {\n      if (err.code === 'ECONNRESET' && req.socket.destroyed) {\n        log.debug('failed to proxy %s (browser hung up the socket)', req.url)\n      } else {\n        log.warn('failed to proxy %s (%s)', req.url, err.message)\n      }\n\n      res.destroy()\n    })\n\n    return {\n      path: proxyPath,\n      baseUrl: pathname,\n      host: hostname,\n      port: port,\n      https: https,\n      proxy: proxy\n    }\n  }), 'path').reverse()\n}\n\n/**\n * Returns a handler which understands the proxies and its redirects, along with the proxy to use\n * @param proxies An array of proxy record objects\n * @param urlRoot The URL root that karma is mounted on\n * @return {Function} handler function\n */\nvar createProxyHandler = function (proxies, urlRoot) {\n  if (!proxies.length) {\n    var nullProxy = function createNullProxy (request, response, next) {\n      return next()\n    }\n    nullProxy.upgrade = function upgradeNullProxy () {}\n    return nullProxy\n  }\n\n  var middleware = function createProxy (request, response, next) {\n    var proxyRecord = _.find(proxies, function (p) {\n      return request.url.indexOf(p.path) === 0\n    })\n\n    if (!proxyRecord) {\n      return next()\n    }\n\n    log.debug('proxying request - %s to %s:%s', request.url, proxyRecord.host, proxyRecord.port)\n    request.url = request.url.replace(proxyRecord.path, proxyRecord.baseUrl)\n    proxyRecord.proxy.web(request, response)\n  }\n\n  middleware.upgrade = function upgradeProxy (request, socket, head) {\n    // special-case karma's route to avoid upgrading it\n    if (request.url.indexOf(urlRoot) === 0) {\n      log.debug('NOT upgrading proxyWebSocketRequest %s', request.url)\n      return\n    }\n\n    var proxyRecord = _.find(proxies, function (p) {\n      return request.url.indexOf(p.path) === 0\n    })\n\n    if (!proxyRecord) {\n      return\n    }\n\n    log.debug('upgrade proxyWebSocketRequest %s to %s:%s',\n      request.url, proxyRecord.host, proxyRecord.port)\n    request.url = request.url.replace(proxyRecord.path, proxyRecord.baseUrl)\n    proxyRecord.proxy.ws(request, socket, head)\n  }\n\n  return middleware\n}\n\nexports.create = function (/* config */ config, /* config.proxies */ proxies) {\n  return createProxyHandler(parseProxyConfig(proxies, config), config.urlRoot)\n}\n"]}