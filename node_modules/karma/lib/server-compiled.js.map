{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["var SocketIO = require('socket.io')\nvar di = require('di')\nvar util = require('util')\nvar Promise = require('bluebird')\n\nvar root = global || window || this\n\nvar cfg = require('./config')\nvar logger = require('./logger')\nvar constant = require('./constants')\nvar watcher = require('./watcher')\nvar plugin = require('./plugin')\n\nvar ws = require('./web-server')\nvar preprocessor = require('./preprocessor')\nvar Launcher = require('./launcher').Launcher\nvar FileList = require('./file-list')\nvar reporter = require('./reporter')\nvar helper = require('./helper')\nvar events = require('./events')\nvar EventEmitter = events.EventEmitter\nvar Executor = require('./executor')\nvar Browser = require('./browser')\nvar BrowserCollection = require('./browser_collection')\nvar EmitterWrapper = require('./emitter_wrapper')\nvar processWrapper = new EmitterWrapper(process)\n\nfunction createSocketIoServer (webServer, executor, config) {\n  var server = new SocketIO(webServer, {\n    // avoid destroying http upgrades from socket.io to get proxied websockets working\n    destroyUpgrade: false,\n    path: config.urlRoot + 'socket.io/',\n    transports: config.transports\n  })\n\n  // hack to overcome circular dependency\n  executor.socketIoSockets = server.sockets\n\n  return server\n}\n\nfunction setupLogger (level, colors) {\n  var logLevel = logLevel || constant.LOG_INFO\n  var logColors = helper.isDefined(colors) ? colors : true\n  logger.setup(logLevel, logColors, [constant.CONSOLE_APPENDER])\n}\n\n// Constructor\nvar Server = function (cliOptions, done) {\n  EventEmitter.call(this)\n\n  setupLogger(cliOptions.logLevel, cliOptions.colors)\n\n  this.log = logger.create()\n\n  var config = cfg.parseConfig(cliOptions.configFile, cliOptions)\n\n  var modules = [{\n    helper: ['value', helper],\n    logger: ['value', logger],\n    done: ['value', done || process.exit],\n    emitter: ['value', this],\n    launcher: ['type', Launcher],\n    config: ['value', config],\n    preprocess: ['factory', preprocessor.createPreprocessor],\n    fileList: ['type', FileList],\n    webServer: ['factory', ws.create],\n    socketServer: ['factory', createSocketIoServer],\n    executor: ['type', Executor],\n    // TODO(vojta): remove\n    customFileHandlers: ['value', []],\n    // TODO(vojta): remove, once karma-dart does not rely on it\n    customScriptTypes: ['value', []],\n    reporter: ['factory', reporter.createReporters],\n    capturedBrowsers: ['type', BrowserCollection],\n    args: ['value', {}],\n    timer: ['value', {\n      setTimeout: function () {\n        return setTimeout.apply(root, arguments)\n      },\n      clearTimeout: function (timeoutId) {\n        clearTimeout(timeoutId)\n      }\n    }]\n  }]\n\n  // Load the plugins\n  modules = modules.concat(plugin.resolve(config.plugins))\n\n  this._injector = new di.Injector(modules)\n}\n\n// Inherit from events.EventEmitter\nutil.inherits(Server, EventEmitter)\n\n// Public Methods\n// --------------\n\n// Start the server\nServer.prototype.start = function () {\n  this._injector.invoke(this._start, this)\n}\n\n/**\n * Backward-compatibility with karma-intellij bundled with WebStorm.\n * Deprecated since version 0.13, to be removed in 0.14\n */\nServer.start = function (cliOptions, done) {\n  var server = new Server(cliOptions, done)\n  server.start()\n}\n\n// Get properties from the injector\n//\n// token - String\nServer.prototype.get = function (token) {\n  return this._injector.get(token)\n}\n\n// Force a refresh of the file list\nServer.prototype.refreshFiles = function () {\n  if (!this._fileList) return Promise.resolve()\n\n  return this._fileList.refresh()\n}\n\n// Private Methods\n// ---------------\n\nServer.prototype._start = function (config, launcher, preprocess, fileList, webServer,\n                                    capturedBrowsers, socketServer, executor, done) {\n  var self = this\n\n  self._fileList = fileList\n\n  config.frameworks.forEach(function (framework) {\n    self._injector.get('framework:' + framework)\n  })\n\n  // A map of launched browsers.\n  var singleRunDoneBrowsers = Object.create(null)\n\n  // Passing fake event emitter, so that it does not emit on the global,\n  // we don't care about these changes.\n  var singleRunBrowsers = new BrowserCollection(new EventEmitter())\n\n  // Some browsers did not get captured.\n  var singleRunBrowserNotCaptured = false\n\n  webServer.on('error', function (e) {\n    if (e.code === 'EADDRINUSE') {\n      self.log.warn('Port %d in use', config.port)\n      config.port++\n      webServer.listen(config.port)\n    } else {\n      throw e\n    }\n  })\n\n  var afterPreprocess = function () {\n    if (config.autoWatch) {\n      self._injector.invoke(watcher.watch)\n    }\n\n    webServer.listen(config.port, function () {\n      self.log.info('Karma v%s server started at %s//%s:%s%s', constant.VERSION,\n        config.protocol, config.hostname, config.port, config.urlRoot)\n\n      if (config.browsers && config.browsers.length) {\n        self._injector.invoke(launcher.launch, launcher).forEach(function (browserLauncher) {\n          singleRunDoneBrowsers[browserLauncher.id] = false\n        })\n      }\n    })\n  }\n\n  fileList.refresh().then(afterPreprocess, afterPreprocess)\n\n  self.on('browsers_change', function () {\n    // TODO(vojta): send only to interested browsers\n    socketServer.sockets.emit('info', capturedBrowsers.serialize())\n  })\n\n  self.on('browser_register', function (browser) {\n    launcher.markCaptured(browser.id)\n\n    // TODO(vojta): This is lame, browser can get captured and then\n    // crash (before other browsers get captured).\n    if (launcher.areAllCaptured()) {\n      self.emit('browsers_ready')\n\n      if (config.autoWatch) {\n        executor.schedule()\n      }\n    }\n  })\n\n  var EVENTS_TO_REPLY = ['start', 'info', 'karma_error', 'result', 'complete']\n  socketServer.sockets.on('connection', function (socket) {\n    self.log.debug('A browser has connected on socket ' + socket.id)\n\n    var replySocketEvents = events.bufferEvents(socket, EVENTS_TO_REPLY)\n\n    socket.on('complete', function (data, ack) {\n      ack()\n    })\n\n    socket.on('register', function (info) {\n      var newBrowser\n      var isRestart\n\n      if (info.id) {\n        newBrowser = capturedBrowsers.getById(info.id) || singleRunBrowsers.getById(info.id)\n      }\n\n      if (newBrowser) {\n        isRestart = newBrowser.state === Browser.STATE_DISCONNECTED\n        newBrowser.reconnect(socket)\n\n        // We are restarting a previously disconnected browser.\n        if (isRestart && config.singleRun) {\n          newBrowser.execute(config.client)\n        }\n      } else {\n        newBrowser = self._injector.createChild([{\n          id: ['value', info.id || null],\n          fullName: ['value', info.name],\n          socket: ['value', socket]\n        }]).instantiate(Browser)\n\n        newBrowser.init()\n\n        // execute in this browser immediately\n        if (config.singleRun) {\n          newBrowser.execute(config.client)\n          singleRunBrowsers.add(newBrowser)\n        }\n      }\n\n      replySocketEvents()\n    })\n  })\n\n  var emitRunCompleteIfAllBrowsersDone = function () {\n    // all browsers done\n    var isDone = Object.keys(singleRunDoneBrowsers).reduce(function (isDone, id) {\n      return isDone && singleRunDoneBrowsers[id]\n    }, true)\n\n    if (isDone) {\n      var results = singleRunBrowsers.getResults()\n      if (singleRunBrowserNotCaptured) {\n        results.exitCode = 1\n      }\n\n      self.emit('run_complete', singleRunBrowsers, results)\n    }\n  }\n\n  if (config.singleRun) {\n    self.on('browser_complete', function (completedBrowser) {\n      if (completedBrowser.lastResult.disconnected &&\n        completedBrowser.disconnectsCount <= config.browserDisconnectTolerance) {\n        self.log.info('Restarting %s (%d of %d attempts)', completedBrowser.name,\n          completedBrowser.disconnectsCount, config.browserDisconnectTolerance)\n        if (!launcher.restart(completedBrowser.id)) {\n          singleRunDoneBrowsers[completedBrowser.id] = true\n          emitRunCompleteIfAllBrowsersDone()\n        }\n      } else {\n        singleRunDoneBrowsers[completedBrowser.id] = true\n\n        if (launcher.kill(completedBrowser.id)) {\n          // workaround to supress \"disconnect\" warning\n          completedBrowser.state = Browser.STATE_DISCONNECTED\n        }\n\n        emitRunCompleteIfAllBrowsersDone()\n      }\n    })\n\n    self.on('browser_process_failure', function (browserLauncher) {\n      singleRunDoneBrowsers[browserLauncher.id] = true\n      singleRunBrowserNotCaptured = true\n\n      emitRunCompleteIfAllBrowsersDone()\n    })\n\n    self.on('run_complete', function (browsers, results) {\n      self.log.debug('Run complete, exiting.')\n      disconnectBrowsers(results.exitCode)\n    })\n\n    self.emit('run_start', singleRunBrowsers)\n  }\n\n  if (config.autoWatch) {\n    self.on('file_list_modified', function () {\n      self.log.debug('List of files has changed, trying to execute')\n      executor.schedule()\n    })\n  }\n\n  var webServerCloseTimeout = 3000\n  var disconnectBrowsers = function (code) {\n    // Slightly hacky way of removing disconnect listeners\n    // to suppress \"browser disconnect\" warnings\n    // TODO(vojta): change the client to not send the event (if disconnected by purpose)\n    var sockets = socketServer.sockets.sockets\n\n    sockets.forEach(function (socket) {\n      socket.removeAllListeners('disconnect')\n      if (!socket.disconnected) {\n        // Disconnect asynchronously. Socket.io mutates the `sockets.sockets` array\n        // underneath us so this would skip every other browser/socket.\n        process.nextTick(socket.disconnect.bind(socket))\n      }\n    })\n\n    var removeAllListenersDone = false\n    var removeAllListeners = function () {\n      // make sure we don't execute cleanup twice\n      if (removeAllListenersDone) {\n        return\n      }\n      removeAllListenersDone = true\n      webServer.removeAllListeners()\n      processWrapper.removeAllListeners()\n      done(code || 0)\n    }\n\n    self.emitAsync('exit').then(function () {\n      // don't wait forever on webServer.close() because\n      // pending client connections prevent it from closing.\n      var closeTimeout = setTimeout(removeAllListeners, webServerCloseTimeout)\n\n      // shutdown the server...\n      webServer.close(function () {\n        clearTimeout(closeTimeout)\n        removeAllListeners()\n      })\n    })\n  }\n\n  processWrapper.on('SIGINT', disconnectBrowsers)\n  processWrapper.on('SIGTERM', disconnectBrowsers)\n\n  // Handle all unhandled exceptions, so we don't just exit but\n  // disconnect the browsers before exiting.\n  processWrapper.on('uncaughtException', function (error) {\n    self.log.error(error)\n    disconnectBrowsers(1)\n  })\n}\n\n// Export\n// ------\n\nmodule.exports = Server\n"]}