{"version":3,"sources":["web-server.js"],"names":[],"mappings":"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","file":"web-server-compiled.js","sourcesContent":["var fs = require('fs')\nvar http = require('http')\nvar https = require('https')\nvar path = require('path')\nvar connect = require('connect')\nvar Promise = require('bluebird')\n\nvar common = require('./middleware/common')\nvar runnerMiddleware = require('./middleware/runner')\nvar stripHostMiddleware = require('./middleware/strip_host')\nvar karmaMiddleware = require('./middleware/karma')\nvar sourceFilesMiddleware = require('./middleware/source_files')\nvar proxyMiddleware = require('./middleware/proxy')\n\nvar log = require('./logger').create('web-server')\n\nvar createCustomHandler = function (customFileHandlers, /* config.basePath */ basePath) {\n  return function (request, response, next) {\n    for (var i = 0; i < customFileHandlers.length; i++) {\n      if (customFileHandlers[i].urlRegex.test(request.url)) {\n        return customFileHandlers[i].handler(request, response, 'fake/static', 'fake/adapter',\n          basePath, 'fake/root')\n      }\n    }\n\n    return next()\n  }\n}\n\ncreateCustomHandler.$inject = ['customFileHandlers', 'config.basePath']\n\nvar createWebServer = function (injector, emitter, fileList) {\n  var config = injector.get('config')\n  var serveStaticFile = common.createServeFile(fs, path.normalize(__dirname + '/../static'))\n  var serveFile = common.createServeFile(fs)\n  var filesPromise = new common.PromiseContainer()\n\n  // Set an empty list of files to avoid race issues with\n  // file_list_modified not having been emitted yet\n  filesPromise.set(Promise.resolve(fileList.files))\n\n  emitter.on('file_list_modified', function (files) {\n    filesPromise.set(Promise.resolve(files))\n  })\n\n  // locals for webserver module\n  // NOTE(vojta): figure out how to do this with DI\n  injector = injector.createChild([{\n    serveFile: ['value', serveFile],\n    serveStaticFile: ['value', serveStaticFile],\n    filesPromise: ['value', filesPromise]\n  }])\n\n  var proxyMiddlewareInstance = injector.invoke(proxyMiddleware.create)\n\n  var handler = connect()\n    .use(injector.invoke(runnerMiddleware.create))\n    .use(injector.invoke(stripHostMiddleware.create))\n    .use(injector.invoke(karmaMiddleware.create))\n    .use(injector.invoke(sourceFilesMiddleware.create))\n    // TODO(vojta): extract the proxy into a plugin\n    .use(proxyMiddlewareInstance)\n    // TODO(vojta): remove, this is only here because of karma-dart\n    // we need a better way of custom handlers\n    .use(injector.invoke(createCustomHandler))\n    .use(function (request, response) {\n      common.serve404(response, request.url)\n    })\n\n  var serverClass = http\n  var serverArguments = [handler]\n\n  if (config.protocol === 'https:') {\n    serverClass = https\n    serverArguments.unshift(config.httpsServerOptions || {})\n  }\n  var server = serverClass.createServer.apply(null, serverArguments)\n\n  server.on('upgrade', function (req, socket, head) {\n    log.debug('upgrade %s', req.url)\n    proxyMiddlewareInstance.upgrade(req, socket, head)\n  })\n\n  return server\n}\n\n// PUBLIC API\nexports.create = createWebServer\n"]}