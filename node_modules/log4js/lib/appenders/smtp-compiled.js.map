{"version":3,"sources":["smtp.js"],"names":[],"mappings":"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","file":"smtp-compiled.js","sourcesContent":["\"use strict\";\nvar layouts = require(\"../layouts\")\n, mailer = require(\"nodemailer\")\n, os = require('os')\n, async = require('async')\n, unsentCount = 0\n, shutdownTimeout;\n\n/**\n* SMTP Appender. Sends logging events using SMTP protocol. \n* It can either send an email on each event or group several \n* logging events gathered during specified interval.\n*\n* @param config appender configuration data\n*    config.sendInterval time between log emails (in seconds), if 0\n*    then every event sends an email\n*    config.shutdownTimeout time to give up remaining emails (in seconds; defaults to 5).\n* @param layout a function that takes a logevent and returns a string (defaults to basicLayout).\n*/\nfunction smtpAppender(config, layout) {\n\tlayout = layout || layouts.basicLayout;\n\tvar subjectLayout = layouts.messagePassThroughLayout;\n\tvar sendInterval = config.sendInterval*1000 || 0;\n\t\n\tvar logEventBuffer = [];\n\tvar sendTimer;\n\t\n\tshutdownTimeout = ('shutdownTimeout' in config ? config.shutdownTimeout : 5) * 1000;\n\t\n\tfunction sendBuffer() {\n    if (logEventBuffer.length > 0) {\n\t\t\n      var transportOpts = getTransportOptions(config);\n      var transport = mailer.createTransport(transportOpts);\n      var firstEvent = logEventBuffer[0];\n      var body = \"\";\n      var count = logEventBuffer.length;\n      while (logEventBuffer.length > 0) {\n        body += layout(logEventBuffer.shift(), config.timezoneOffset) + \"\\n\";\n      }\n\n      var msg = {\n        to: config.recipients,\n        subject: config.subject || subjectLayout(firstEvent),\n        headers: { \"Hostname\": os.hostname() }\n      };\n\t  \n      if (!config.html) {\n\tmsg.text = body;\n      } else {\n    \tmsg.html = body;\n      }\n      \n      if (config.sender) {\n        msg.from = config.sender;\n      }\n      transport.sendMail(msg, function(error, success) {\n        if (error) {\n          console.error(\"log4js.smtpAppender - Error happened\", error);\n        }\n        transport.close();\n        unsentCount -= count;\n      });\n    }\n\t}\n\t\n\tfunction scheduleSend() {\n\t\tif (!sendTimer) {\n\t\t\tsendTimer = setTimeout(function() {\n\t\t\t\tsendTimer = null; \n\t\t\t\tsendBuffer();\n\t\t\t}, sendInterval);\n    }\n\t}\n\t\n\tfunction getTransportOptions(config) {\n        var transportOpts = null;\n        if( config.SMTP ) {\n            transportOpts = config.SMTP;\n        } else if( config.transport ) {\n            var plugin = config.transport.plugin || 'smtp';\n            var transportModule = 'nodemailer-' + plugin + '-transport';\n            var transporter = require( transportModule );\n            transportOpts = transporter( config.transport.options );\n        }\n\n        return transportOpts;\n\t}\n\t\n\treturn function(loggingEvent) {\n\t\tunsentCount++;\n\t\tlogEventBuffer.push(loggingEvent);\n\t\tif (sendInterval > 0) {\n\t\t\tscheduleSend();\n\t\t} else {\n\t\t\tsendBuffer();\n    }\n\t};\n}\n\nfunction configure(config) {\n\tvar layout;\n\tif (config.layout) {\n\t\tlayout = layouts.layout(config.layout.type, config.layout);\n\t}\n\treturn smtpAppender(config, layout);\n}\n\nfunction shutdown(cb) {\n\tif (shutdownTimeout > 0) {\n\t\tsetTimeout(function() { unsentCount = 0; }, shutdownTimeout);\n\t}\n\tasync.whilst(function() {\n\t\treturn unsentCount > 0;\n\t}, function(done) {\n\t\tsetTimeout(done, 100);\n\t}, cb);\n}\n\nexports.name = \"smtp\";\nexports.appender = smtpAppender;\nexports.configure = configure;\nexports.shutdown = shutdown;\n\n"]}