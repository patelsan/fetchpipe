{"version":3,"sources":["connect-logger.js"],"names":[],"mappings":"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","file":"connect-logger-compiled.js","sourcesContent":["\"use strict\";\nvar levels = require(\"./levels\");\nvar _ = require('underscore');\nvar DEFAULT_FORMAT = ':remote-addr - -' +\n  ' \":method :url HTTP/:http-version\"' +\n  ' :status :content-length \":referrer\"' +\n  ' \":user-agent\"';\n/**\n * Log requests with the given `options` or a `format` string.\n *\n * Options:\n *\n *   - `format`        Format string, see below for tokens\n *   - `level`         A log4js levels instance. Supports also 'auto'\n *\n * Tokens:\n *\n *   - `:req[header]` ex: `:req[Accept]`\n *   - `:res[header]` ex: `:res[Content-Length]`\n *   - `:http-version`\n *   - `:response-time`\n *   - `:remote-addr`\n *   - `:date`\n *   - `:method`\n *   - `:url`\n *   - `:referrer`\n *   - `:user-agent`\n *   - `:status`\n *\n * @param {String|Function|Object} format or options\n * @return {Function}\n * @api public\n */\n\nfunction getLogger(logger4js, options) {\n\tif ('object' == typeof options) {\n\t\toptions = options || {};\n\t} else if (options) {\n\t\toptions = { format: options };\n\t} else {\n\t\toptions = {};\n\t}\n\n\tvar thislogger = logger4js\n  , level = levels.toLevel(options.level, levels.INFO)\n  , fmt = options.format || DEFAULT_FORMAT\n  , nolog = options.nolog ? createNoLogCondition(options.nolog) : null;\n\n  return function (req, res, next) {\n    // mount safety\n    if (req._logging) return next();\n\n\t\t// nologs\n\t\tif (nolog && nolog.test(req.originalUrl)) return next();\n\t\tif (thislogger.isLevelEnabled(level) || options.level === 'auto') {\n\n\t\t\tvar start = new Date()\n\t\t\t, statusCode\n\t\t\t, writeHead = res.writeHead\n\t\t\t, url = req.originalUrl;\n\n\t\t\t// flag as logging\n\t\t\treq._logging = true;\n\n\t\t\t// proxy for statusCode.\n\t\t\tres.writeHead = function(code, headers){\n\t\t\t\tres.writeHead = writeHead;\n\t\t\t\tres.writeHead(code, headers);\n\t\t\t\tres.__statusCode = statusCode = code;\n\t\t\t\tres.__headers = headers || {};\n\n\t\t\t\t//status code response level handling\n\t\t\t\tif(options.level === 'auto'){\n\t\t\t\t\tlevel = levels.INFO;\n\t\t\t\t\tif(code >= 300) level = levels.WARN;\n\t\t\t\t\tif(code >= 400) level = levels.ERROR;\n\t\t\t\t} else {\n\t\t\t\t\tlevel = levels.toLevel(options.level, levels.INFO);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t//hook on end request to emit the log entry of the HTTP request.\n\t\t\tres.on('finish', function() {\n\t\t\t\tres.responseTime = new Date() - start;\n\t\t\t\t//status code response level handling\n\t\t\t\tif(res.statusCode && options.level === 'auto'){\n\t\t\t\t\tlevel = levels.INFO;\n\t\t\t\t\tif(res.statusCode >= 300) level = levels.WARN;\n\t\t\t\t\tif(res.statusCode >= 400) level = levels.ERROR;\n\t\t\t\t}\n\t\t\t\tif (thislogger.isLevelEnabled(level)) {\n          var combined_tokens = assemble_tokens(req, res, options.tokens || []);\n\t\t\t\t\tif (typeof fmt === 'function') {\n\t\t\t\t\t\tvar line = fmt(req, res, function(str){ return format(str, combined_tokens); });\n\t\t\t\t\t\tif (line) thislogger.log(level, line);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthislogger.log(level, format(fmt, combined_tokens));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n    //ensure next gets always called\n    next();\n  };\n}\n\n/**\n * Adds custom {token, replacement} objects to defaults, overwriting the defaults if any tokens clash\n *\n * @param  {IncomingMessage} req\n * @param  {ServerResponse} res\n * @param  {Array} custom_tokens [{ token: string-or-regexp, replacement: string-or-replace-function }]\n * @return {Array}\n */\nfunction assemble_tokens(req, res, custom_tokens) {\n  var array_unique_tokens = function(array) {\n    var a = array.concat();\n    for(var i=0; i<a.length; ++i) {\n      for(var j=i+1; j<a.length; ++j) {\n        if(a[i].token == a[j].token) { // not === because token can be regexp object\n          a.splice(j--, 1);\n        }\n      }\n    }\n    return a;\n  };\n\n  var default_tokens = [];\n  default_tokens.push({ token: ':url', replacement: req.originalUrl });\n  default_tokens.push({ token: ':protocol', replacement: req.protocol });\n  default_tokens.push({ token: ':hostname', replacement: req.hostname });\n  default_tokens.push({ token: ':method', replacement: req.method });\n  default_tokens.push({ token: ':status', replacement: res.__statusCode || res.statusCode });\n  default_tokens.push({ token: ':response-time', replacement: res.responseTime });\n  default_tokens.push({ token: ':date', replacement: new Date().toUTCString() });\n  default_tokens.push({ token: ':referrer', replacement: req.headers.referer || req.headers.referrer || '' });\n  default_tokens.push({ token: ':http-version', replacement: req.httpVersionMajor + '.' + req.httpVersionMinor });\n  default_tokens.push({ token: ':remote-addr', replacement: req.headers['x-forwarded-for'] || req.ip || req._remoteAddress ||\n    (req.socket && (req.socket.remoteAddress || (req.socket.socket && req.socket.socket.remoteAddress))) });\n  default_tokens.push({ token: ':user-agent', replacement: req.headers['user-agent'] });\n  default_tokens.push({ token: ':content-length', replacement: (res._headers && res._headers['content-length']) ||\n      (res.__headers && res.__headers['Content-Length']) || '-' });\n  default_tokens.push({ token: /:req\\[([^\\]]+)\\]/g, replacement: function(_, field) {\n    return req.headers[field.toLowerCase()];\n  } });\n  default_tokens.push({ token: /:res\\[([^\\]]+)\\]/g, replacement: function(_, field) {\n    return res._headers ?\n      (res._headers[field.toLowerCase()] || res.__headers[field])\n      : (res.__headers && res.__headers[field]);\n  } });\n\n  return array_unique_tokens(custom_tokens.concat(default_tokens));\n};\n\n/**\n * Return formatted log line.\n *\n * @param  {String} str\n * @param  {IncomingMessage} req\n * @param  {ServerResponse} res\n * @return {String}\n * @api private\n */\n\nfunction format(str, tokens) {\n  return _.reduce(tokens, function(current_string, token) {\n    return current_string.replace(token.token, token.replacement);\n  }, str);\n}\n\n/**\n * Return RegExp Object about nolog\n *\n * @param  {String} nolog\n * @return {RegExp}\n * @api private\n *\n * syntax\n *  1. String\n *   1.1 \"\\\\.gif\"\n *         NOT LOGGING http://example.com/hoge.gif and http://example.com/hoge.gif?fuga\n *         LOGGING http://example.com/hoge.agif\n *   1.2 in \"\\\\.gif|\\\\.jpg$\"\n *         NOT LOGGING http://example.com/hoge.gif and\n *           http://example.com/hoge.gif?fuga and http://example.com/hoge.jpg?fuga\n *         LOGGING http://example.com/hoge.agif,\n *           http://example.com/hoge.ajpg and http://example.com/hoge.jpg?hoge\n *   1.3 in \"\\\\.(gif|jpe?g|png)$\"\n *         NOT LOGGING http://example.com/hoge.gif and http://example.com/hoge.jpeg\n *         LOGGING http://example.com/hoge.gif?uid=2 and http://example.com/hoge.jpg?pid=3\n *  2. RegExp\n *   2.1 in /\\.(gif|jpe?g|png)$/\n *         SAME AS 1.3\n *  3. Array\n *   3.1 [\"\\\\.jpg$\", \"\\\\.png\", \"\\\\.gif\"]\n *         SAME AS \"\\\\.jpg|\\\\.png|\\\\.gif\"\n */\nfunction createNoLogCondition(nolog) {\n  var regexp = null;\n\n\tif (nolog) {\n    if (nolog instanceof RegExp) {\n      regexp = nolog;\n    }\n\n    if (typeof nolog === 'string') {\n      regexp = new RegExp(nolog);\n    }\n\n    if (Array.isArray(nolog)) {\n      var regexpsAsStrings = nolog.map(\n        function convertToStrings(o) {\n          return o.source ? o.source : o;\n        }\n      );\n      regexp = new RegExp(regexpsAsStrings.join('|'));\n    }\n  }\n\n  return regexp;\n}\n\nexports.connectLogger = getLogger;\n"]}