{"version":3,"sources":["PerMessageDeflate.js"],"names":[],"mappings":"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","file":"PerMessageDeflate-compiled.js","sourcesContent":["\nvar zlib = require('zlib');\n\nvar AVAILABLE_WINDOW_BITS = [8, 9, 10, 11, 12, 13, 14, 15];\nvar DEFAULT_WINDOW_BITS = 15;\nvar DEFAULT_MEM_LEVEL = 8;\n\nPerMessageDeflate.extensionName = 'permessage-deflate';\n\n/**\n * Per-message Compression Extensions implementation\n */\n\nfunction PerMessageDeflate(options, isServer) {\n  if (this instanceof PerMessageDeflate === false) {\n    throw new TypeError(\"Classes can't be function-called\");\n  }\n\n  this._options = options || {};\n  this._isServer = !!isServer;\n  this._inflate = null;\n  this._deflate = null;\n  this.params = null;\n}\n\n/**\n * Create extension parameters offer\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.offer = function() {\n  var params = {};\n  if (this._options.serverNoContextTakeover) {\n    params.server_no_context_takeover = true;\n  }\n  if (this._options.clientNoContextTakeover) {\n    params.client_no_context_takeover = true;\n  }\n  if (this._options.serverMaxWindowBits) {\n    params.server_max_window_bits = this._options.serverMaxWindowBits;\n  }\n  if (this._options.clientMaxWindowBits) {\n    params.client_max_window_bits = this._options.clientMaxWindowBits;\n  } else if (this._options.clientMaxWindowBits == null) {\n    params.client_max_window_bits = true;\n  }\n  return params;\n};\n\n/**\n * Accept extension offer\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.accept = function(paramsList) {\n  paramsList = this.normalizeParams(paramsList);\n\n  var params;\n  if (this._isServer) {\n    params = this.acceptAsServer(paramsList);\n  } else {\n    params = this.acceptAsClient(paramsList);\n  }\n\n  this.params = params;\n  return params;\n};\n\n/**\n * Accept extension offer from client\n *\n * @api private\n */\n\nPerMessageDeflate.prototype.acceptAsServer = function(paramsList) {\n  var accepted = {};\n  var result = paramsList.some(function(params) {\n    accepted = {};\n    if (this._options.serverNoContextTakeover === false && params.server_no_context_takeover) {\n      return;\n    }\n    if (this._options.serverMaxWindowBits === false && params.server_max_window_bits) {\n      return;\n    }\n    if (typeof this._options.serverMaxWindowBits === 'number' &&\n        typeof params.server_max_window_bits === 'number' &&\n        this._options.serverMaxWindowBits > params.server_max_window_bits) {\n      return;\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number' && !params.client_max_window_bits) {\n      return;\n    }\n\n    if (this._options.serverNoContextTakeover || params.server_no_context_takeover) {\n      accepted.server_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (this._options.clientNoContextTakeover !== false && params.client_no_context_takeover) {\n      accepted.client_no_context_takeover = true;\n    }\n    if (typeof this._options.serverMaxWindowBits === 'number') {\n      accepted.server_max_window_bits = this._options.serverMaxWindowBits;\n    } else if (typeof params.server_max_window_bits === 'number') {\n      accepted.server_max_window_bits = params.server_max_window_bits;\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number') {\n      accepted.client_max_window_bits = this._options.clientMaxWindowBits;\n    } else if (this._options.clientMaxWindowBits !== false && typeof params.client_max_window_bits === 'number') {\n      accepted.client_max_window_bits = params.client_max_window_bits;\n    }\n    return true;\n  }, this);\n\n  if (!result) {\n    throw new Error('Doesn\\'t support the offered configuration');\n  }\n\n  return accepted;\n};\n\n/**\n * Accept extension response from server\n *\n * @api privaye\n */\n\nPerMessageDeflate.prototype.acceptAsClient = function(paramsList) {\n  var params = paramsList[0];\n  if (this._options.clientNoContextTakeover != null) {\n    if (this._options.clientNoContextTakeover === false && params.client_no_context_takeover) {\n      throw new Error('Invalid value for \"client_no_context_takeover\"');\n    }\n  }\n  if (this._options.clientMaxWindowBits != null) {\n    if (this._options.clientMaxWindowBits === false && params.client_max_window_bits) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n    if (typeof this._options.clientMaxWindowBits === 'number' &&\n        (!params.client_max_window_bits || params.client_max_window_bits > this._options.clientMaxWindowBits)) {\n      throw new Error('Invalid value for \"client_max_window_bits\"');\n    }\n  }\n  return params;\n};\n\n/**\n * Normalize extensions parameters\n *\n * @api private\n */\n\nPerMessageDeflate.prototype.normalizeParams = function(paramsList) {\n  return paramsList.map(function(params) {\n    Object.keys(params).forEach(function(key) {\n      var value = params[key];\n      if (value.length > 1) {\n        throw new Error('Multiple extension parameters for ' + key);\n      }\n\n      value = value[0];\n\n      switch (key) {\n      case 'server_no_context_takeover':\n      case 'client_no_context_takeover':\n        if (value !== true) {\n          throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n        }\n        params[key] = true;\n        break;\n      case 'server_max_window_bits':\n      case 'client_max_window_bits':\n        if (typeof value === 'string') {\n          value = parseInt(value, 10);\n          if (!~AVAILABLE_WINDOW_BITS.indexOf(value)) {\n            throw new Error('invalid extension parameter value for ' + key + ' (' + value + ')');\n          }\n        }\n        if (!this._isServer && value === true) {\n          throw new Error('Missing extension parameter value for ' + key);\n        }\n        params[key] = value;\n        break;\n      default:\n        throw new Error('Not defined extension parameter (' + key + ')');\n      }\n    }, this);\n    return params;\n  }, this);\n};\n\n/**\n * Decompress message\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.decompress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'client' : 'server';\n\n  if (!this._inflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._inflate = zlib.createInflateRaw({\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS\n    });\n  }\n\n  var self = this;\n  var buffers = [];\n\n  this._inflate.on('error', onError).on('data', onData);\n  this._inflate.write(data);\n  if (fin) {\n    this._inflate.write(new Buffer([0x00, 0x00, 0xff, 0xff]));\n  }\n  this._inflate.flush(function() {\n    cleanup();\n    callback(null, Buffer.concat(buffers));\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n    buffers.push(data);\n  }\n\n  function cleanup() {\n    self._inflate.removeListener('error', onError);\n    self._inflate.removeListener('data', onData);\n    if (fin && self.params[endpoint + '_no_context_takeover']) {\n      self._inflate = null;\n    }\n  }\n};\n\n/**\n * Compress message\n *\n * @api public\n */\n\nPerMessageDeflate.prototype.compress = function (data, fin, callback) {\n  var endpoint = this._isServer ? 'server' : 'client';\n\n  if (!this._deflate) {\n    var maxWindowBits = this.params[endpoint + '_max_window_bits'];\n    this._deflate = zlib.createDeflateRaw({\n      flush: zlib.Z_SYNC_FLUSH,\n      windowBits: 'number' === typeof maxWindowBits ? maxWindowBits : DEFAULT_WINDOW_BITS,\n      memLevel: this._options.memLevel || DEFAULT_MEM_LEVEL\n    });\n  }\n\n  var self = this;\n  var buffers = [];\n\n  this._deflate.on('error', onError).on('data', onData);\n  this._deflate.write(data);\n  this._deflate.flush(function() {\n    cleanup();\n    var data = Buffer.concat(buffers);\n    if (fin) {\n      data = data.slice(0, data.length - 4);\n    }\n    callback(null, data);\n  });\n\n  function onError(err) {\n    cleanup();\n    callback(err);\n  }\n\n  function onData(data) {\n    buffers.push(data);\n  }\n\n  function cleanup() {\n    self._deflate.removeListener('error', onError);\n    self._deflate.removeListener('data', onData);\n    if (fin && self.params[endpoint + '_no_context_takeover']) {\n      self._deflate = null;\n    }\n  }\n};\n\nmodule.exports = PerMessageDeflate;\n"]}